<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<!--
 | Generated by Apache Maven Doxia at 2024-10-22
 | Rendered using Apache Maven Stylus Skin 1.5
-->
<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <title>Apache Hadoop Amazon Web Services support &#x2013; Testing the S3A filesystem client and its features</title>
    <style type="text/css" media="all">
      @import url("../../css/maven-base.css");
      @import url("../../css/maven-theme.css");
      @import url("../../css/site.css");
    </style>
    <link rel="stylesheet" href="../../css/print.css" type="text/css" media="print" />
        <meta name="Date-Revision-yyyymmdd" content="20241022" />
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
                </head>
  <body class="composite">
    <div id="banner">
                        <a href="http://hadoop.apache.org/" id="bannerLeft">
                                        <img src="http://hadoop.apache.org/images/hadoop-logo.jpg" alt="" />
                </a>
                              <a href="http://www.apache.org/" id="bannerRight">
                                        <img src="http://www.apache.org/images/asf_logo_wide.png" alt="" />
                </a>
            <div class="clear">
        <hr/>
      </div>
    </div>
    <div id="breadcrumbs">
            
                                     <div class="xright">            <a href="http://wiki.apache.org/hadoop" class="externalLink">Wiki</a>
            |
                <a href="https://gitbox.apache.org/repos/asf/hadoop.git" class="externalLink">git</a>
              
                                   &nbsp;| Last Published: 2024-10-22
              &nbsp;| Version: 3.5.0-SNAPSHOT
            </div>
      <div class="clear">
        <hr/>
      </div>
    </div>
    <div id="leftColumn">
      <div id="navcolumn">
             
                                                   <h5>General</h5>
                  <ul>
                  <li class="none">
                  <a href="../../../index.html">Overview</a>
            </li>
                  <li class="none">
                  <a href="../../../hadoop-project-dist/hadoop-common/SingleCluster.html">Single Node Setup</a>
            </li>
                  <li class="none">
                  <a href="../../../hadoop-project-dist/hadoop-common/ClusterSetup.html">Cluster Setup</a>
            </li>
                  <li class="none">
                  <a href="../../../hadoop-project-dist/hadoop-common/CommandsManual.html">Commands Reference</a>
            </li>
                  <li class="none">
                  <a href="../../../hadoop-project-dist/hadoop-common/FileSystemShell.html">FileSystem Shell</a>
            </li>
                  <li class="none">
                  <a href="../../../hadoop-project-dist/hadoop-common/Compatibility.html">Compatibility Specification</a>
            </li>
                  <li class="none">
                  <a href="../../../hadoop-project-dist/hadoop-common/DownstreamDev.html">Downstream Developer's Guide</a>
            </li>
                  <li class="none">
                  <a href="../../../hadoop-project-dist/hadoop-common/AdminCompatibilityGuide.html">Admin Compatibility Guide</a>
            </li>
                  <li class="none">
                  <a href="../../../hadoop-project-dist/hadoop-common/InterfaceClassification.html">Interface Classification</a>
            </li>
                  <li class="none">
                  <a href="../../../hadoop-project-dist/hadoop-common/filesystem/index.html">FileSystem Specification</a>
            </li>
          </ul>
                       <h5>Common</h5>
                  <ul>
                  <li class="none">
                  <a href="../../../hadoop-project-dist/hadoop-common/CLIMiniCluster.html">CLI Mini Cluster</a>
            </li>
                  <li class="none">
                  <a href="../../../hadoop-project-dist/hadoop-common/FairCallQueue.html">Fair Call Queue</a>
            </li>
                  <li class="none">
                  <a href="../../../hadoop-project-dist/hadoop-common/NativeLibraries.html">Native Libraries</a>
            </li>
                  <li class="none">
                  <a href="../../../hadoop-project-dist/hadoop-common/Superusers.html">Proxy User</a>
            </li>
                  <li class="none">
                  <a href="../../../hadoop-project-dist/hadoop-common/RackAwareness.html">Rack Awareness</a>
            </li>
                  <li class="none">
                  <a href="../../../hadoop-project-dist/hadoop-common/SecureMode.html">Secure Mode</a>
            </li>
                  <li class="none">
                  <a href="../../../hadoop-project-dist/hadoop-common/ServiceLevelAuth.html">Service Level Authorization</a>
            </li>
                  <li class="none">
                  <a href="../../../hadoop-project-dist/hadoop-common/HttpAuthentication.html">HTTP Authentication</a>
            </li>
                  <li class="none">
                  <a href="../../../hadoop-project-dist/hadoop-common/CredentialProviderAPI.html">Credential Provider API</a>
            </li>
                  <li class="none">
                  <a href="../../../hadoop-kms/index.html">Hadoop KMS</a>
            </li>
                  <li class="none">
                  <a href="../../../hadoop-project-dist/hadoop-common/Tracing.html">Tracing</a>
            </li>
                  <li class="none">
                  <a href="../../../hadoop-project-dist/hadoop-common/UnixShellGuide.html">Unix Shell Guide</a>
            </li>
                  <li class="none">
                  <a href="../../../hadoop-project-dist/hadoop-common/registry/index.html">Registry</a>
            </li>
                  <li class="none">
                  <a href="../../../hadoop-project-dist/hadoop-common/AsyncProfilerServlet.html">Async Profiler</a>
            </li>
          </ul>
                       <h5>HDFS</h5>
                  <ul>
                  <li class="none">
                  <a href="../../../hadoop-project-dist/hadoop-hdfs/HdfsDesign.html">Architecture</a>
            </li>
                  <li class="none">
                  <a href="../../../hadoop-project-dist/hadoop-hdfs/HdfsUserGuide.html">User Guide</a>
            </li>
                  <li class="none">
                  <a href="../../../hadoop-project-dist/hadoop-hdfs/HDFSCommands.html">Commands Reference</a>
            </li>
                  <li class="none">
                  <a href="../../../hadoop-project-dist/hadoop-hdfs/HDFSHighAvailabilityWithQJM.html">NameNode HA With QJM</a>
            </li>
                  <li class="none">
                  <a href="../../../hadoop-project-dist/hadoop-hdfs/HDFSHighAvailabilityWithNFS.html">NameNode HA With NFS</a>
            </li>
                  <li class="none">
                  <a href="../../../hadoop-project-dist/hadoop-hdfs/ObserverNameNode.html">Observer NameNode</a>
            </li>
                  <li class="none">
                  <a href="../../../hadoop-project-dist/hadoop-hdfs/Federation.html">Federation</a>
            </li>
                  <li class="none">
                  <a href="../../../hadoop-project-dist/hadoop-hdfs/ViewFs.html">ViewFs</a>
            </li>
                  <li class="none">
                  <a href="../../../hadoop-project-dist/hadoop-hdfs/ViewFsOverloadScheme.html">ViewFsOverloadScheme</a>
            </li>
                  <li class="none">
                  <a href="../../../hadoop-project-dist/hadoop-hdfs/HdfsSnapshots.html">Snapshots</a>
            </li>
                  <li class="none">
                  <a href="../../../hadoop-project-dist/hadoop-hdfs/HdfsEditsViewer.html">Edits Viewer</a>
            </li>
                  <li class="none">
                  <a href="../../../hadoop-project-dist/hadoop-hdfs/HdfsImageViewer.html">Image Viewer</a>
            </li>
                  <li class="none">
                  <a href="../../../hadoop-project-dist/hadoop-hdfs/HdfsPermissionsGuide.html">Permissions and HDFS</a>
            </li>
                  <li class="none">
                  <a href="../../../hadoop-project-dist/hadoop-hdfs/HdfsQuotaAdminGuide.html">Quotas and HDFS</a>
            </li>
                  <li class="none">
                  <a href="../../../hadoop-project-dist/hadoop-hdfs/LibHdfs.html">libhdfs (C API)</a>
            </li>
                  <li class="none">
                  <a href="../../../hadoop-project-dist/hadoop-hdfs/WebHDFS.html">WebHDFS (REST API)</a>
            </li>
                  <li class="none">
                  <a href="../../../hadoop-hdfs-httpfs/index.html">HttpFS</a>
            </li>
                  <li class="none">
                  <a href="../../../hadoop-project-dist/hadoop-hdfs/ShortCircuitLocalReads.html">Short Circuit Local Reads</a>
            </li>
                  <li class="none">
                  <a href="../../../hadoop-project-dist/hadoop-hdfs/CentralizedCacheManagement.html">Centralized Cache Management</a>
            </li>
                  <li class="none">
                  <a href="../../../hadoop-project-dist/hadoop-hdfs/HdfsNfsGateway.html">NFS Gateway</a>
            </li>
                  <li class="none">
                  <a href="../../../hadoop-project-dist/hadoop-hdfs/HdfsRollingUpgrade.html">Rolling Upgrade</a>
            </li>
                  <li class="none">
                  <a href="../../../hadoop-project-dist/hadoop-hdfs/ExtendedAttributes.html">Extended Attributes</a>
            </li>
                  <li class="none">
                  <a href="../../../hadoop-project-dist/hadoop-hdfs/TransparentEncryption.html">Transparent Encryption</a>
            </li>
                  <li class="none">
                  <a href="../../../hadoop-project-dist/hadoop-hdfs/HdfsMultihoming.html">Multihoming</a>
            </li>
                  <li class="none">
                  <a href="../../../hadoop-project-dist/hadoop-hdfs/ArchivalStorage.html">Storage Policies</a>
            </li>
                  <li class="none">
                  <a href="../../../hadoop-project-dist/hadoop-hdfs/MemoryStorage.html">Memory Storage Support</a>
            </li>
                  <li class="none">
                  <a href="../../../hadoop-project-dist/hadoop-hdfs/SLGUserGuide.html">Synthetic Load Generator</a>
            </li>
                  <li class="none">
                  <a href="../../../hadoop-project-dist/hadoop-hdfs/HDFSErasureCoding.html">Erasure Coding</a>
            </li>
                  <li class="none">
                  <a href="../../../hadoop-project-dist/hadoop-hdfs/HDFSDiskbalancer.html">Disk Balancer</a>
            </li>
                  <li class="none">
                  <a href="../../../hadoop-project-dist/hadoop-hdfs/HdfsUpgradeDomain.html">Upgrade Domain</a>
            </li>
                  <li class="none">
                  <a href="../../../hadoop-project-dist/hadoop-hdfs/HdfsDataNodeAdminGuide.html">DataNode Admin</a>
            </li>
                  <li class="none">
                  <a href="../../../hadoop-project-dist/hadoop-hdfs-rbf/HDFSRouterFederation.html">Router Federation</a>
            </li>
                  <li class="none">
                  <a href="../../../hadoop-project-dist/hadoop-hdfs/HdfsProvidedStorage.html">Provided Storage</a>
            </li>
          </ul>
                       <h5>MapReduce</h5>
                  <ul>
                  <li class="none">
                  <a href="../../../hadoop-mapreduce-client/hadoop-mapreduce-client-core/MapReduceTutorial.html">Tutorial</a>
            </li>
                  <li class="none">
                  <a href="../../../hadoop-mapreduce-client/hadoop-mapreduce-client-core/MapredCommands.html">Commands Reference</a>
            </li>
                  <li class="none">
                  <a href="../../../hadoop-mapreduce-client/hadoop-mapreduce-client-core/MapReduce_Compatibility_Hadoop1_Hadoop2.html">Compatibility with 1.x</a>
            </li>
                  <li class="none">
                  <a href="../../../hadoop-mapreduce-client/hadoop-mapreduce-client-core/EncryptedShuffle.html">Encrypted Shuffle</a>
            </li>
                  <li class="none">
                  <a href="../../../hadoop-mapreduce-client/hadoop-mapreduce-client-core/PluggableShuffleAndPluggableSort.html">Pluggable Shuffle/Sort</a>
            </li>
                  <li class="none">
                  <a href="../../../hadoop-mapreduce-client/hadoop-mapreduce-client-core/DistributedCacheDeploy.html">Distributed Cache Deploy</a>
            </li>
                  <li class="none">
                  <a href="../../../hadoop-mapreduce-client/hadoop-mapreduce-client-core/SharedCacheSupport.html">Support for YARN Shared Cache</a>
            </li>
          </ul>
                       <h5>MapReduce REST APIs</h5>
                  <ul>
                  <li class="none">
                  <a href="../../../hadoop-mapreduce-client/hadoop-mapreduce-client-core/MapredAppMasterRest.html">MR Application Master</a>
            </li>
                  <li class="none">
                  <a href="../../../hadoop-mapreduce-client/hadoop-mapreduce-client-hs/HistoryServerRest.html">MR History Server</a>
            </li>
          </ul>
                       <h5>YARN</h5>
                  <ul>
                  <li class="none">
                  <a href="../../../hadoop-yarn/hadoop-yarn-site/YARN.html">Architecture</a>
            </li>
                  <li class="none">
                  <a href="../../../hadoop-yarn/hadoop-yarn-site/YarnCommands.html">Commands Reference</a>
            </li>
                  <li class="none">
                  <a href="../../../hadoop-yarn/hadoop-yarn-site/CapacityScheduler.html">Capacity Scheduler</a>
            </li>
                  <li class="none">
                  <a href="../../../hadoop-yarn/hadoop-yarn-site/FairScheduler.html">Fair Scheduler</a>
            </li>
                  <li class="none">
                  <a href="../../../hadoop-yarn/hadoop-yarn-site/ResourceManagerRestart.html">ResourceManager Restart</a>
            </li>
                  <li class="none">
                  <a href="../../../hadoop-yarn/hadoop-yarn-site/ResourceManagerHA.html">ResourceManager HA</a>
            </li>
                  <li class="none">
                  <a href="../../../hadoop-yarn/hadoop-yarn-site/ResourceModel.html">Resource Model</a>
            </li>
                  <li class="none">
                  <a href="../../../hadoop-yarn/hadoop-yarn-site/NodeLabel.html">Node Labels</a>
            </li>
                  <li class="none">
                  <a href="../../../hadoop-yarn/hadoop-yarn-site/NodeAttributes.html">Node Attributes</a>
            </li>
                  <li class="none">
                  <a href="../../../hadoop-yarn/hadoop-yarn-site/WebApplicationProxy.html">Web Application Proxy</a>
            </li>
                  <li class="none">
                  <a href="../../../hadoop-yarn/hadoop-yarn-site/TimelineServer.html">Timeline Server</a>
            </li>
                  <li class="none">
                  <a href="../../../hadoop-yarn/hadoop-yarn-site/TimelineServiceV2.html">Timeline Service V.2</a>
            </li>
                  <li class="none">
                  <a href="../../../hadoop-yarn/hadoop-yarn-site/WritingYarnApplications.html">Writing YARN Applications</a>
            </li>
                  <li class="none">
                  <a href="../../../hadoop-yarn/hadoop-yarn-site/YarnApplicationSecurity.html">YARN Application Security</a>
            </li>
                  <li class="none">
                  <a href="../../../hadoop-yarn/hadoop-yarn-site/NodeManager.html">NodeManager</a>
            </li>
                  <li class="none">
                  <a href="../../../hadoop-yarn/hadoop-yarn-site/DockerContainers.html">Running Applications in Docker Containers</a>
            </li>
                  <li class="none">
                  <a href="../../../hadoop-yarn/hadoop-yarn-site/RuncContainers.html">Running Applications in runC Containers</a>
            </li>
                  <li class="none">
                  <a href="../../../hadoop-yarn/hadoop-yarn-site/NodeManagerCgroups.html">Using CGroups</a>
            </li>
                  <li class="none">
                  <a href="../../../hadoop-yarn/hadoop-yarn-site/SecureContainer.html">Secure Containers</a>
            </li>
                  <li class="none">
                  <a href="../../../hadoop-yarn/hadoop-yarn-site/ReservationSystem.html">Reservation System</a>
            </li>
                  <li class="none">
                  <a href="../../../hadoop-yarn/hadoop-yarn-site/GracefulDecommission.html">Graceful Decommission</a>
            </li>
                  <li class="none">
                  <a href="../../../hadoop-yarn/hadoop-yarn-site/OpportunisticContainers.html">Opportunistic Containers</a>
            </li>
                  <li class="none">
                  <a href="../../../hadoop-yarn/hadoop-yarn-site/Federation.html">YARN Federation</a>
            </li>
                  <li class="none">
                  <a href="../../../hadoop-yarn/hadoop-yarn-site/SharedCache.html">Shared Cache</a>
            </li>
                  <li class="none">
                  <a href="../../../hadoop-yarn/hadoop-yarn-site/UsingGpus.html">Using GPU</a>
            </li>
                  <li class="none">
                  <a href="../../../hadoop-yarn/hadoop-yarn-site/UsingFPGA.html">Using FPGA</a>
            </li>
                  <li class="none">
                  <a href="../../../hadoop-yarn/hadoop-yarn-site/PlacementConstraints.html">Placement Constraints</a>
            </li>
                  <li class="none">
                  <a href="../../../hadoop-yarn/hadoop-yarn-site/YarnUI2.html">YARN UI2</a>
            </li>
          </ul>
                       <h5>YARN REST APIs</h5>
                  <ul>
                  <li class="none">
                  <a href="../../../hadoop-yarn/hadoop-yarn-site/WebServicesIntro.html">Introduction</a>
            </li>
                  <li class="none">
                  <a href="../../../hadoop-yarn/hadoop-yarn-site/ResourceManagerRest.html">Resource Manager</a>
            </li>
                  <li class="none">
                  <a href="../../../hadoop-yarn/hadoop-yarn-site/NodeManagerRest.html">Node Manager</a>
            </li>
                  <li class="none">
                  <a href="../../../hadoop-yarn/hadoop-yarn-site/TimelineServer.html#Timeline_Server_REST_API_v1">Timeline Server</a>
            </li>
                  <li class="none">
                  <a href="../../../hadoop-yarn/hadoop-yarn-site/TimelineServiceV2.html#Timeline_Service_v.2_REST_API">Timeline Service V.2</a>
            </li>
          </ul>
                       <h5>YARN Service</h5>
                  <ul>
                  <li class="none">
                  <a href="../../../hadoop-yarn/hadoop-yarn-site/yarn-service/Overview.html">Overview</a>
            </li>
                  <li class="none">
                  <a href="../../../hadoop-yarn/hadoop-yarn-site/yarn-service/QuickStart.html">QuickStart</a>
            </li>
                  <li class="none">
                  <a href="../../../hadoop-yarn/hadoop-yarn-site/yarn-service/Concepts.html">Concepts</a>
            </li>
                  <li class="none">
                  <a href="../../../hadoop-yarn/hadoop-yarn-site/yarn-service/YarnServiceAPI.html">Yarn Service API</a>
            </li>
                  <li class="none">
                  <a href="../../../hadoop-yarn/hadoop-yarn-site/yarn-service/ServiceDiscovery.html">Service Discovery</a>
            </li>
                  <li class="none">
                  <a href="../../../hadoop-yarn/hadoop-yarn-site/yarn-service/SystemServices.html">System Services</a>
            </li>
          </ul>
                       <h5>Hadoop Compatible File Systems</h5>
                  <ul>
                  <li class="none">
                  <a href="../../../hadoop-aliyun/tools/hadoop-aliyun/index.html">Aliyun OSS</a>
            </li>
                  <li class="none">
                  <a href="../../../hadoop-aws/tools/hadoop-aws/index.html">Amazon S3</a>
            </li>
                  <li class="none">
                  <a href="../../../hadoop-azure/index.html">Azure Blob Storage</a>
            </li>
                  <li class="none">
                  <a href="../../../hadoop-azure-datalake/index.html">Azure Data Lake Storage</a>
            </li>
                  <li class="none">
                  <a href="../../../hadoop-cos/cloud-storage/index.html">Tencent COS</a>
            </li>
                  <li class="none">
                  <a href="../../../hadoop-huaweicloud/cloud-storage/index.html">Huaweicloud OBS</a>
            </li>
          </ul>
                       <h5>Auth</h5>
                  <ul>
                  <li class="none">
                  <a href="../../../hadoop-auth/index.html">Overview</a>
            </li>
                  <li class="none">
                  <a href="../../../hadoop-auth/Examples.html">Examples</a>
            </li>
                  <li class="none">
                  <a href="../../../hadoop-auth/Configuration.html">Configuration</a>
            </li>
                  <li class="none">
                  <a href="../../../hadoop-auth/BuildingIt.html">Building</a>
            </li>
          </ul>
                       <h5>Tools</h5>
                  <ul>
                  <li class="none">
                  <a href="../../../hadoop-streaming/HadoopStreaming.html">Hadoop Streaming</a>
            </li>
                  <li class="none">
                  <a href="../../../hadoop-archives/HadoopArchives.html">Hadoop Archives</a>
            </li>
                  <li class="none">
                  <a href="../../../hadoop-archive-logs/HadoopArchiveLogs.html">Hadoop Archive Logs</a>
            </li>
                  <li class="none">
                  <a href="../../../hadoop-distcp/DistCp.html">DistCp</a>
            </li>
                  <li class="none">
                  <a href="../../../hadoop-federation-balance/HDFSFederationBalance.html">HDFS Federation Balance</a>
            </li>
                  <li class="none">
                  <a href="../../../hadoop-gridmix/GridMix.html">GridMix</a>
            </li>
                  <li class="none">
                  <a href="../../../hadoop-rumen/Rumen.html">Rumen</a>
            </li>
                  <li class="none">
                  <a href="../../../hadoop-resourceestimator/ResourceEstimator.html">Resource Estimator Service</a>
            </li>
                  <li class="none">
                  <a href="../../../hadoop-sls/SchedulerLoadSimulator.html">Scheduler Load Simulator</a>
            </li>
                  <li class="none">
                  <a href="../../../hadoop-project-dist/hadoop-common/Benchmarking.html">Hadoop Benchmarking</a>
            </li>
                  <li class="none">
                  <a href="../../../hadoop-dynamometer/Dynamometer.html">Dynamometer</a>
            </li>
          </ul>
                       <h5>Reference</h5>
                  <ul>
                  <li class="none">
                  <a href="../../../hadoop-project-dist/hadoop-common/release/">Changelog and Release Notes</a>
            </li>
                  <li class="none">
                  <a href="../../../api/index.html">Java API docs</a>
            </li>
                  <li class="none">
                  <a href="../../../hadoop-project-dist/hadoop-common/UnixShellAPI.html">Unix Shell API</a>
            </li>
                  <li class="none">
                  <a href="../../../hadoop-project-dist/hadoop-common/Metrics.html">Metrics</a>
            </li>
          </ul>
                       <h5>Configuration</h5>
                  <ul>
                  <li class="none">
                  <a href="../../../hadoop-project-dist/hadoop-common/core-default.xml">core-default.xml</a>
            </li>
                  <li class="none">
                  <a href="../../../hadoop-project-dist/hadoop-hdfs/hdfs-default.xml">hdfs-default.xml</a>
            </li>
                  <li class="none">
                  <a href="../../../hadoop-project-dist/hadoop-hdfs-rbf/hdfs-rbf-default.xml">hdfs-rbf-default.xml</a>
            </li>
                  <li class="none">
                  <a href="../../../hadoop-mapreduce-client/hadoop-mapreduce-client-core/mapred-default.xml">mapred-default.xml</a>
            </li>
                  <li class="none">
                  <a href="../../../hadoop-yarn/hadoop-yarn-common/yarn-default.xml">yarn-default.xml</a>
            </li>
                  <li class="none">
                  <a href="../../../hadoop-kms/kms-default.html">kms-default.xml</a>
            </li>
                  <li class="none">
                  <a href="../../../hadoop-hdfs-httpfs/httpfs-default.html">httpfs-default.xml</a>
            </li>
                  <li class="none">
                  <a href="../../../hadoop-project-dist/hadoop-common/DeprecatedProperties.html">Deprecated Properties</a>
            </li>
          </ul>
                                 <a href="http://maven.apache.org/" title="Built by Maven" class="poweredBy">
          <img alt="Built by Maven" src="../../images/logos/maven-feather.png"/>
        </a>
                       
                               </div>
    </div>
    <div id="bodyColumn">
      <div id="contentBox">
        <!---
  Licensed under the Apache License, Version 2.0 (the "License");
  you may not use this file except in compliance with the License.
  You may obtain a copy of the License at

   http://www.apache.org/licenses/LICENSE-2.0

  Unless required by applicable law or agreed to in writing, software
  distributed under the License is distributed on an "AS IS" BASIS,
  WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
  See the License for the specific language governing permissions and
  limitations under the License. See accompanying LICENSE file.
-->
<h1>Testing the S3A filesystem client and its features</h1>
<ul>
<li><a href="#Policy_for_submitting_patches_which_affect_the_hadoop-aws_module."> Policy for submitting patches which affect the hadoop-aws module.</a>
<ul>
<li><a href="#The_submitter_of_any_patch_is_required_to_run_all_the_integration_tests_and_declare_which_S3_region.2Fimplementation_they_used.">The submitter of any patch is required to run all the integration tests and declare which S3 region/implementation they used.</a></li>
<li><a href="#What_if_there.E2.80.99s_an_intermittent_failure_of_a_test.3F">What if there&#x2019;s an intermittent failure of a test?</a></li>
<li><a href="#What_if_the_tests_are_timing_out_or_failing_over_my_network_connection.3F">What if the tests are timing out or failing over my network connection?</a></li></ul></li>
<li><a href="#Setting_up_the_tests"> Setting up the tests</a>
<ul>
<li><a href="#File_core-site.xml">File core-site.xml</a></li>
<li><a href="#File_auth-keys.xml">File auth-keys.xml</a></li></ul></li>
<li><a href="#Configuring_S3a_Encryption"> Configuring S3a Encryption</a>
<ul>
<li><a href="#Default_Encryption"> Default Encryption</a></li>
<li><a href="#Disabling_the_encryption_tests">Disabling the encryption tests</a></li></ul></li>
<li><a href="#Running_the_Tests"> Running the Tests</a>
<ul>
<li><a href="#Testing_against_different_regions"> Testing against different regions</a></li>
<li><a href="#CSV_Data_Tests"> CSV Data Tests</a></li>
<li><a href="#Testing_Access_Point_Integration"> Testing Access Point Integration</a></li></ul></li>
<li><a href="#Viewing_Integration_Test_Reports"> Viewing Integration Test Reports</a></li>
<li><a href="#Testing_Versioned_Stores"> Testing Versioned Stores</a></li>
<li><a href="#Testing_Different_Marker_Retention_Policy"> Testing Different Marker Retention Policy</a>
<ul>
<li><a href="#Enabling_auditing_of_markers">Enabling auditing of markers</a></li></ul></li>
<li><a href="#Enabling_prefetch_for_all_tests"> Enabling prefetch for all tests</a></li>
<li><a href="#Scale_Tests"> Scale Tests</a>
<ul>
<li><a href="#Enabling_the_Scale_Tests"> Enabling the Scale Tests</a></li>
<li><a href="#Tuning_scale_options_from_Maven"> Tuning scale options from Maven</a></li>
<li><a href="#Scale_test_configuration_options"> Scale test configuration options</a></li></ul></li>
<li><a href="#Testing_through_continuous_integration"> Testing through continuous integration</a>
<ul>
<li><a href="#Parallel_CI_builds.">Parallel CI builds.</a></li>
<li><a href="#Securing_CI_builds">Securing CI builds</a></li></ul></li>
<li><a href="#Load_tests."> Load tests.</a></li>
<li><a href="#Testing_against_non-AWS_S3_Stores."> Testing against non-AWS S3 Stores.</a>
<ul>
<li><a href="#Public_datasets_used_in_tests">Public datasets used in tests</a></li>
<li><a href="#Disabling_the_storage_class_tests">Disabling the storage class tests</a></li>
<li><a href="#Configuring_the_CSV_file_read_tests">Configuring the CSV file read tests</a></li>
<li><a href="#Enabling_prefetch_for_all_tests"> Enabling prefetch for all tests</a></li>
<li><a href="#Testing_Requester_Pays">Testing Requester Pays</a></li>
<li><a href="#Testing_Session_Credentials">Testing Session Credentials</a></li>
<li><a href="#Disabling_Content_Encoding_tests">Disabling Content Encoding tests</a></li>
<li><a href="#Tests_which_may_fail_.28and_which_you_can_ignore.29">Tests which may fail (and which you can ignore)</a></li></ul></li>
<li><a href="#Debugging_Test_failures"> Debugging Test failures</a></li>
<li><a href="#Adding_new_tests"> Adding new tests</a></li>
<li><a href="#Requirements_of_new_Tests"> Requirements of new Tests</a>
<ul>
<li><a href="#Subclasses_Existing_Shared_Base_Classes">Subclasses Existing Shared Base Classes</a></li>
<li><a href="#Secure">Secure</a></li>
<li><a href="#Efficient_of_Time_and_Money">Efficient of Time and Money</a></li>
<li><a href="#Works_With_Other_S3_Stored">Works With Other S3 Stored</a></li>
<li><a href="#Works_Over_Long-haul_Links">Works Over Long-haul Links</a></li>
<li><a href="#Provides_Diagnostics_and_timing_information">Provides Diagnostics and timing information</a></li>
<li><a href="#Fails_Meaningfully">Fails Meaningfully</a></li>
<li><a href="#Sets_up_its_filesystem_and_checks_for_those_settings">Sets up its filesystem and checks for those settings</a></li>
<li><a href="#Cleans_Up_Afterwards">Cleans Up Afterwards</a></li>
<li><a href="#Works_Reliably">Works Reliably</a></li>
<li><a href="#Runs_in_parallel_unless_this_is_unworkable.">Runs in parallel unless this is unworkable.</a></li>
<li><a href="#Individual_test_cases_can_be_run_in_an_IDE">Individual test cases can be run in an IDE</a></li>
<li><a href="#Keeping_AWS_Costs_down">Keeping AWS Costs down</a></li></ul></li>
<li><a href="#Tips"> Tips</a>
<ul>
<li><a href="#How_to_keep_your_credentials_really_safe">How to keep your credentials really safe</a></li></ul></li>
<li><a href="#Failure_Injection">Failure Injection</a></li>
<li><a href="#Testing_Assumed_Roles"> Testing Assumed Roles</a></li>
<li><a href="#Qualifying_an_AWS_SDK_Update"> Qualifying an AWS SDK Update</a>
<ul>
<li><a href="#Basic_command_line_regression_testing">Basic command line regression testing</a></li>
<li><a href="#Other_tests">Other tests</a></li>
<li><a href="#Dealing_with_Deprecated_APIs_and_New_Features">Dealing with Deprecated APIs and New Features</a></li>
<li><a href="#Committing_the_patch">Committing the patch</a></li></ul></li></ul>

<p>This module includes both unit tests, which can run in isolation without connecting to the S3 service, and integration tests, which require a working connection to S3 to interact with a bucket.  Unit test suites follow the naming convention <code>Test*.java</code>.  Integration tests follow the naming convention <code>ITest*.java</code>.</p><section>
<h2><a name="Policy_for_submitting_patches_which_affect_the_hadoop-aws_module."></a><a name="policy"></a> Policy for submitting patches which affect the <code>hadoop-aws</code> module.</h2>
<p>The Apache Jenkins infrastructure does not run any S3 integration tests, due to the need to keep credentials secure.</p><section>
<h3><a name="The_submitter_of_any_patch_is_required_to_run_all_the_integration_tests_and_declare_which_S3_region.2Fimplementation_they_used."></a>The submitter of any patch is required to run all the integration tests and declare which S3 region/implementation they used.</h3>
<p>This is important: <b>patches which do not include this declaration will be ignored</b></p>
<p>This policy has proven to be the only mechanism to guarantee full regression testing of code changes. Why the declaration of region? Two reasons</p>
<ol style="list-style-type: decimal">

<li>It helps us identify regressions which only surface against specific endpoints or third-party implementations of the S3 protocol.</li>
<li>It forces the submitters to be more honest about their testing. It&#x2019;s easy to lie, &#x201c;yes, I tested this&#x201d;. To say &#x201c;yes, I tested this against S3 US-west&#x201d; is a more specific lie and harder to make. And, if you get caught out: you lose all credibility with the project.</li>
</ol>
<p>You don&#x2019;t need to test from a VM within the AWS infrastructure; with the <code>-Dparallel-tests</code> option the non-scale tests complete in under twenty minutes. Because the tests clean up after themselves, they are also designed to be low cost. It&#x2019;s neither hard nor expensive to run the tests; if you can&#x2019;t, there&#x2019;s no guarantee your patch works. The reviewers have enough to do, and don&#x2019;t have the time to do these tests, especially as every failure will simply make for a slow iterative development.</p>
<p>Please: run the tests. And if you don&#x2019;t, we are sorry for declining your patch, but we have to.</p></section><section>
<h3><a name="What_if_there.E2.80.99s_an_intermittent_failure_of_a_test.3F"></a>What if there&#x2019;s an intermittent failure of a test?</h3>
<p>Some of the tests do fail intermittently, especially in parallel runs. If this happens, try to run the test on its own to see if the test succeeds.</p>
<p>If it still fails, include this fact in your declaration. We know some tests are intermittently unreliable.</p></section><section>
<h3><a name="What_if_the_tests_are_timing_out_or_failing_over_my_network_connection.3F"></a>What if the tests are timing out or failing over my network connection?</h3>
<p>The tests and the S3A client are designed to be configurable for different timeouts. If you are seeing problems and this configuration isn&#x2019;t working, that&#x2019;s a sign of the configuration mechanism isn&#x2019;t complete. If it&#x2019;s happening in the production code, that could be a sign of a problem which may surface over long-haul connections. Please help us identify and fix these problems &#x2014; especially as you are the one best placed to verify the fixes work.</p></section></section><section>
<h2><a name="Setting_up_the_tests"></a><a name="setting-up"></a> Setting up the tests</h2>
<p>To integration test the S3* filesystem clients, you need to provide <code>auth-keys.xml</code> which passes in authentication details to the test runner.</p>
<p>It is a Hadoop XML configuration file, which must be placed into <code>hadoop-tools/hadoop-aws/src/test/resources</code>.</p><section>
<h3><a name="File_core-site.xml"></a>File <code>core-site.xml</code></h3>
<p>This file pre-exists and sources the configurations created under <code>auth-keys.xml</code>.</p>
<p>For most purposes you will not need to edit this file unless you need to apply a specific, non-default property change during the tests.</p></section><section>
<h3><a name="File_auth-keys.xml"></a>File <code>auth-keys.xml</code></h3>
<p>The presence of this file triggers the testing of the S3 classes.</p>
<p>Without this file, <i>none of the integration tests in this module will be executed</i>.</p>
<p>The XML file must contain all the ID/key information needed to connect each of the filesystem clients to the object stores, and a URL for each filesystem for its testing.</p>
<ol style="list-style-type: decimal">

<li><code>test.fs.s3a.name</code> : the URL of the bucket for S3a tests</li>
<li><code>fs.contract.test.fs.s3a</code> : the URL of the bucket for S3a filesystem contract tests</li>
</ol>
<p>The contents of the bucket will be destroyed during the test process: do not use the bucket for any purpose other than testing. Furthermore, for s3a, all in-progress multi-part uploads to the bucket will be aborted at the start of a test (by forcing <code>fs.s3a.multipart.purge=true</code>) to clean up the temporary state of previously failed tests.</p>
<p>Example:</p>

<div class="source">
<div class="source">
<pre>&lt;configuration&gt;

  &lt;property&gt;
    &lt;name&gt;test.fs.s3a.name&lt;/name&gt;
    &lt;value&gt;s3a://test-aws-s3a/&lt;/value&gt;
  &lt;/property&gt;

  &lt;property&gt;
    &lt;name&gt;fs.contract.test.fs.s3a&lt;/name&gt;
    &lt;value&gt;${test.fs.s3a.name}&lt;/value&gt;
  &lt;/property&gt;

  &lt;property&gt;
    &lt;name&gt;fs.s3a.access.key&lt;/name&gt;
    &lt;description&gt;AWS access key ID. Omit for IAM role-based authentication.&lt;/description&gt;
    &lt;value&gt;DONOTCOMMITTHISKEYTOSCM&lt;/value&gt;
  &lt;/property&gt;

  &lt;property&gt;
    &lt;name&gt;fs.s3a.secret.key&lt;/name&gt;
    &lt;description&gt;AWS secret key. Omit for IAM role-based authentication.&lt;/description&gt;
    &lt;value&gt;DONOTEVERSHARETHISSECRETKEY!&lt;/value&gt;
  &lt;/property&gt;

  &lt;property&gt;
    &lt;name&gt;test.sts.endpoint&lt;/name&gt;
    &lt;description&gt;Specific endpoint to use for STS requests.&lt;/description&gt;
    &lt;value&gt;sts.amazonaws.com&lt;/value&gt;
  &lt;/property&gt;

&lt;/configuration&gt;
</pre></div></div>
</section></section><section>
<h2><a name="Configuring_S3a_Encryption"></a><a name="encryption"></a> Configuring S3a Encryption</h2>
<p>For S3a encryption tests to run correctly, the <code>fs.s3a.encryption.key</code> must be configured in the s3a contract xml file or <code>auth-keys.xml</code> file with a AWS KMS encryption key arn as this value is different for each AWS KMS. Please note this KMS key should be created in the same region as your S3 bucket. Otherwise, you may get <code>KMS.NotFoundException</code>.</p>
<p>Example:</p>

<div class="source">
<div class="source">
<pre>&lt;property&gt;
  &lt;name&gt;fs.s3a.encryption.key&lt;/name&gt;
  &lt;value&gt;arn:aws:kms:us-west-2:360379543683:key/071a86ff-8881-4ba0-9230-95af6d01ca01&lt;/value&gt;
&lt;/property&gt;
</pre></div></div>

<p>You can also force all the tests to run with a specific SSE encryption method by configuring the property <code>fs.s3a.encryption.algorithm</code> in the s3a contract file.</p><section>
<h3><a name="Default_Encryption"></a><a name="default_encyption"></a> Default Encryption</h3>
<p>Buckets can be configured with <a class="externalLink" href="https://docs.aws.amazon.com/AmazonS3/latest/dev/bucket-encryption.html">default encryption</a> on the AWS side. Some S3AFileSystem tests are skipped when default encryption is enabled due to unpredictability in how <a class="externalLink" href="https://docs.aws.amazon.com/AmazonS3/latest/API/RESTCommonResponseHeaders.html">ETags</a> are generated.</p></section><section>
<h3><a name="Disabling_the_encryption_tests"></a>Disabling the encryption tests</h3>
<p>If the S3 store/storage class doesn&#x2019;t support server-side-encryption, these will fail. They can be turned off.</p>

<div class="source">
<div class="source">
<pre>&lt;property&gt;
  &lt;name&gt;test.fs.s3a.encryption.enabled&lt;/name&gt;
  &lt;value&gt;false&lt;/value&gt;
&lt;/property&gt;
</pre></div></div>

<p>Encryption is only used for those specific test suites with <code>Encryption</code> in their classname.</p></section></section><section>
<h2><a name="Running_the_Tests"></a><a name="running"></a> Running the Tests</h2>
<p>After completing the configuration, execute the test run through Maven.</p>

<div class="source">
<div class="source">
<pre>mvn clean verify
</pre></div></div>

<p>It&#x2019;s also possible to execute multiple test suites in parallel by passing the <code>parallel-tests</code> property on the command line.  The tests spend most of their time blocked on network I/O with the S3 service, so running in parallel tends to complete full test runs faster.</p>

<div class="source">
<div class="source">
<pre>mvn -Dparallel-tests clean verify
</pre></div></div>

<p>Some tests must run with exclusive access to the S3 bucket, so even with the <code>parallel-tests</code> property, several test suites will run in serial in a separate Maven execution step after the parallel tests.</p>
<p>By default, <code>parallel-tests</code> runs 4 test suites concurrently.  This can be tuned by passing the <code>testsThreadCount</code> property.</p>

<div class="source">
<div class="source">
<pre>mvn -Dparallel-tests -DtestsThreadCount=8 clean verify
</pre></div></div>

<p>To run just unit tests, which do not require S3 connectivity or AWS credentials, use any of the above invocations, but switch the goal to <code>test</code> instead of <code>verify</code>.</p>

<div class="source">
<div class="source">
<pre>mvn clean test

mvn -Dparallel-tests clean test

mvn -Dparallel-tests -DtestsThreadCount=8 clean test
</pre></div></div>

<p>To run only a specific named subset of tests, pass the <code>test</code> property for unit tests or the <code>it.test</code> property for integration tests.</p>

<div class="source">
<div class="source">
<pre>mvn clean test -Dtest=TestS3AInputPolicies

mvn clean verify -Dit.test=ITestS3AFileContextStatistics -Dtest=none

mvn clean verify -Dtest=TestS3A* -Dit.test=ITestS3A*
</pre></div></div>

<p>Note that when running a specific subset of tests, the patterns passed in <code>test</code> and <code>it.test</code> override the configuration of which tests need to run in isolation in a separate serial phase (mentioned above).  This can cause unpredictable results, so the recommendation is to avoid passing <code>parallel-tests</code> in combination with <code>test</code> or <code>it.test</code>.  If you know that you are specifying only tests that can run safely in parallel, then it will work.  For wide patterns, like <code>ITestS3A*</code> shown above, it may cause unpredictable test failures.</p><section>
<h3><a name="Testing_against_different_regions"></a><a name="regions"></a> Testing against different regions</h3>
<p>S3A can connect to different regions &#x2014;the tests support this. Simply define the target region in <code>auth-keys.xml</code>.</p>

<div class="source">
<div class="source">
<pre>&lt;property&gt;
  &lt;name&gt;fs.s3a.endpoint.region&lt;/name&gt;
  &lt;value&gt;eu-central-1&lt;/value&gt;
&lt;/property&gt;
</pre></div></div>
</section><section>
<h3><a name="CSV_Data_Tests"></a><a name="csv"></a> CSV Data Tests</h3>
<p>The <code>TestS3AInputStreamPerformance</code> tests require read access to a multi-MB text file. The default file for these tests is a public one. <code>s3a://noaa-cors-pds/raw/2023/001/akse/AKSE001a.23_.gz</code> from the <a class="externalLink" href="https://registry.opendata.aws/noaa-ncn/">NOAA Continuously Operating Reference Stations (CORS) Network (NCN)</a></p>
<p>Historically it was required to be a <code>csv.gz</code> file to validate S3 Select support. Now that S3 Select support has been removed, other large files may be used instead.</p>
<p>The path to this object is set in the option <code>fs.s3a.scale.test.csvfile</code>,</p>

<div class="source">
<div class="source">
<pre>&lt;property&gt;
  &lt;name&gt;fs.s3a.scale.test.csvfile&lt;/name&gt;
  &lt;value&gt;s3a://noaa-cors-pds/raw/2023/001/akse/AKSE001a.23_.gz&lt;/value&gt;
&lt;/property&gt;
</pre></div></div>

<ol style="list-style-type: decimal">

<li>If the option is not overridden, the default value is used. This is hosted in Amazon&#x2019;s US-east datacenter.</li>
<li>If <code>fs.s3a.scale.test.csvfile</code> is empty, tests which require it will be skipped.</li>
<li>If the data cannot be read for any reason then the test will fail.</li>
<li>If the property is set to a different path, then that data must be readable and &#x201c;sufficiently&#x201d; large.</li>
<li>If a <code>.gz</code> file, expect decompression-related test failures.</li>
</ol>
<p>(the reason the space or newline is needed is to add &#x201c;an empty entry&#x201d;; an empty <code>&lt;value/&gt;</code> would be considered undefined and pick up the default)</p>
<p>If using a test file in a different AWS S3 region then a bucket-specific region must be defined. For the default test dataset, hosted in the <code>noaa-cors-pds</code> bucket, this is:</p>

<div class="source">
<div class="source">
<pre>  &lt;property&gt;
    &lt;name&gt;fs.s3a.bucket.noaa-cors-pds.endpoint.region&lt;/name&gt;
    &lt;value&gt;us-east-1&lt;/value&gt;
  &lt;/property&gt;
</pre></div></div>
</section><section>
<h3><a name="Testing_Access_Point_Integration"></a><a name="access"></a> Testing Access Point Integration</h3>
<p>S3a supports using Access Point ARNs to access data in S3. If you think your changes affect VPC integration, request signing, ARN manipulation, or any code path that deals with the actual sending and retrieving of data to/from S3, make sure you run the entire integration test suite with this feature enabled.</p>
<p>Check out <a href="./index.html#accesspoints">our documentation</a> for steps on how to enable this feature. To create access points for your S3 bucket you can use the AWS Console or CLI.</p></section></section><section>
<h2><a name="Viewing_Integration_Test_Reports"></a><a name="reporting"></a> Viewing Integration Test Reports</h2>
<p>Integration test results and logs are stored in <code>target/failsafe-reports/</code>. An HTML report can be generated during site generation, or with the <code>surefire-report</code> plugin:</p>

<div class="source">
<div class="source">
<pre>mvn surefire-report:failsafe-report-only
</pre></div></div>
</section><section>
<h2><a name="Testing_Versioned_Stores"></a><a name="versioning"></a> Testing Versioned Stores</h2>
<p>Some tests (specifically some in <code>ITestS3ARemoteFileChanged</code>) require a versioned bucket for full test coverage.</p>
<p>To enable versioning in a bucket.</p>
<ol style="list-style-type: decimal">

<li>In the AWS S3 Management console find and select the bucket.</li>
<li>In the Properties &#x201c;tab&#x201d;, set it as versioned.</li>
<li><i>Important</i> Create a lifecycle rule to automatically clean up old versions after 24h. This avoids running up bills for objects which tests runs create and then delete.</li>
<li>Run the tests again.</li>
</ol>
<p>Once a bucket is converted to being versioned, it cannot be converted back to being unversioned.</p></section><section>
<h2><a name="Testing_Different_Marker_Retention_Policy"></a><a name="marker"></a> Testing Different Marker Retention Policy</h2>
<p>Hadoop supports <a href="directory_markers.html">different policies for directory marker retention</a> -essentially the classic &#x201c;delete&#x201d; and the higher-performance &#x201c;keep&#x201d; options; &#x201c;authoritative&#x201d; is just &#x201c;keep&#x201d; restricted to a part of the bucket.</p>
<p>Example: test with <code>markers=keep</code></p>

<div class="source">
<div class="source">
<pre>mvn verify -Dparallel-tests -DtestsThreadCount=4 -Dmarkers=keep
</pre></div></div>

<p>This is the default and does not need to be explicitly set.</p>
<p>Example: test with <code>markers=delete</code></p>

<div class="source">
<div class="source">
<pre>mvn verify -Dparallel-tests -DtestsThreadCount=4 -Dmarkers=delete
</pre></div></div>

<p>Example: test with <code>markers=authoritative</code></p>

<div class="source">
<div class="source">
<pre>mvn verify -Dparallel-tests -DtestsThreadCount=4 -Dmarkers=authoritative
</pre></div></div>

<p>This final option is of limited use unless paths in the bucket have actually been configured to be of mixed status; unless anything is set up then the outcome should equal that of &#x201c;delete&#x201d;</p><section>
<h3><a name="Enabling_auditing_of_markers"></a>Enabling auditing of markers</h3>
<p>To enable an audit of the output directory of every test suite, enable the option <code>fs.s3a.directory.marker.audit</code></p>

<div class="source">
<div class="source">
<pre>-Dfs.s3a.directory.marker.audit=true
</pre></div></div>

<p>When set, if the marker policy is to delete markers under the test output directory, then the marker tool audit command will be run. This will fail if a marker was found.</p>
<p>This adds extra overhead to every operation, but helps verify that the connector is not keeping markers where it needs to be deleting them -and hence backwards compatibility is maintained.</p></section></section><section>
<h2><a name="Enabling_prefetch_for_all_tests"></a><a name="enabling-prefetch"></a> Enabling prefetch for all tests</h2>
<p>The tests are run with prefetch if the <code>prefetch</code> property is set in the maven build. This can be combined with the scale tests as well.</p>

<div class="source">
<div class="source">
<pre>mvn verify -Dprefetch

mvn verify -Dparallel-tests -Dprefetch -DtestsThreadCount=8

mvn verify -Dparallel-tests -Dprefetch -Dscale -DtestsThreadCount=8
</pre></div></div>
</section><section>
<h2><a name="Scale_Tests"></a><a name="scale"></a> Scale Tests</h2>
<p>There are a set of tests designed to measure the scalability and performance at scale of the S3A tests, <i>Scale Tests</i>. Tests include: creating and traversing directory trees, uploading large files, renaming them, deleting them, seeking through the files, performing random IO, and others. This makes them a foundational part of the benchmarking.</p>
<p>By their very nature they are slow. And, as their execution time is often limited by bandwidth between the computer running the tests and the S3 endpoint, parallel execution does not speed these tests up.</p><section>
<h3><a name="Enabling_the_Scale_Tests"></a><a name="enabling-scale"></a> Enabling the Scale Tests</h3>
<p>The tests are enabled if the <code>scale</code> property is set in the maven build this can be done regardless of whether or not the parallel test profile is used</p>

<div class="source">
<div class="source">
<pre>mvn verify -Dscale

mvn verify -Dparallel-tests -Dscale -DtestsThreadCount=8
</pre></div></div>

<p>The most bandwidth intensive tests (those which upload data) always run sequentially; those which are slow due to HTTPS setup costs or server-side actions are included in the set of parallelized tests.</p></section><section>
<h3><a name="Tuning_scale_options_from_Maven"></a><a name="tuning_scale"></a> Tuning scale options from Maven</h3>
<p>Some of the tests can be tuned from the maven build or from the configuration file used to run the tests.</p>

<div class="source">
<div class="source">
<pre>mvn verify -Dparallel-tests -Dscale -DtestsThreadCount=8 -Dfs.s3a.scale.test.huge.filesize=128M
</pre></div></div>

<p>The algorithm is</p>
<ol style="list-style-type: decimal">

<li>The value is queried from the configuration file, using a default value if it is not set.</li>
<li>The value is queried from the JVM System Properties, where it is passed down by maven.</li>
<li>If the system property is null, an empty string, or it has the value <code>unset</code>, then the configuration value is used. The <code>unset</code> option is used to <a class="externalLink" href="http://stackoverflow.com/questions/7773134/null-versus-empty-arguments-in-maven">work round a quirk in maven property propagation</a>.</li>
</ol>
<p>Only a few properties can be set this way; more will be added.</p>
<table border="0" class="bodyTable">
<thead>

<tr class="a">
<th> Property </th>
<th> Meaning </th></tr>
</thead><tbody>

<tr class="b">
<td> <code>fs.s3a.scale.test.timeout</code></td>
<td> Timeout in seconds for scale tests </td></tr>
<tr class="a">
<td> <code>fs.s3a.scale.test.huge.filesize</code></td>
<td> Size for huge file uploads </td></tr>
<tr class="b">
<td> <code>fs.s3a.scale.test.huge.huge.partitionsize</code></td>
<td> Size for partitions in huge file uploads </td></tr>
</tbody>
</table>
<p>The file and partition sizes are numeric values with a k/m/g/t/p suffix depending on the desired size. For example: 128M, 128m, 2G, 2G, 4T or even 1P.</p></section><section>
<h3><a name="Scale_test_configuration_options"></a><a name="scale-config"></a> Scale test configuration options</h3>
<p>Some scale tests perform multiple operations (such as creating many directories).</p>
<p>The exact number of operations to perform is configurable in the option <code>scale.test.operation.count</code></p>

<div class="source">
<div class="source">
<pre>&lt;property&gt;
  &lt;name&gt;scale.test.operation.count&lt;/name&gt;
  &lt;value&gt;10&lt;/value&gt;
&lt;/property&gt;
</pre></div></div>

<p>Larger values generate more load, and are recommended when testing locally, or in batch runs.</p>
<p>Smaller values results in faster test runs, especially when the object store is a long way away.</p>
<p>Operations which work on directories have a separate option: this controls the width and depth of tests creating recursive directories. Larger values create exponentially more directories, with consequent performance impact.</p>

<div class="source">
<div class="source">
<pre>&lt;property&gt;
  &lt;name&gt;scale.test.directory.count&lt;/name&gt;
  &lt;value&gt;2&lt;/value&gt;
&lt;/property&gt;
</pre></div></div>

<p>DistCp tests targeting S3A support a configurable file size.  The default is 10 MB, but the configuration value is expressed in KB so that it can be tuned smaller to achieve faster test runs.</p>

<div class="source">
<div class="source">
<pre>&lt;property&gt;
  &lt;name&gt;scale.test.distcp.file.size.kb&lt;/name&gt;
  &lt;value&gt;10240&lt;/value&gt;
&lt;/property&gt;
</pre></div></div>

<p>S3A specific scale test properties are</p>
<p><i><code>fs.s3a.scale.test.huge.filesize</code>: size in MB for &#x201c;Huge file tests&#x201d;.</i></p>
<p>The Huge File tests validate S3A&#x2019;s ability to handle large files &#x2014;the property <code>fs.s3a.scale.test.huge.filesize</code> declares the file size to use.</p>

<div class="source">
<div class="source">
<pre>&lt;property&gt;
  &lt;name&gt;fs.s3a.scale.test.huge.filesize&lt;/name&gt;
  &lt;value&gt;200M&lt;/value&gt;
&lt;/property&gt;
</pre></div></div>

<p>Amazon S3 handles files larger than 5GB differently than smaller ones. Setting the huge filesize to a number greater than that) validates support for huge files.</p>

<div class="source">
<div class="source">
<pre>&lt;property&gt;
  &lt;name&gt;fs.s3a.scale.test.huge.filesize&lt;/name&gt;
  &lt;value&gt;6G&lt;/value&gt;
&lt;/property&gt;
</pre></div></div>

<p>Tests at this scale are slow: they are best executed from hosts running in the cloud infrastructure where the S3 endpoint is based. Otherwise, set a large timeout in <code>fs.s3a.scale.test.timeout</code></p>

<div class="source">
<div class="source">
<pre>&lt;property&gt;
  &lt;name&gt;fs.s3a.scale.test.timeout&lt;/name&gt;
  &lt;value&gt;432000&lt;/value&gt;
&lt;/property&gt;
</pre></div></div>

<p>The tests are executed in an order to only clean up created files after the end of all the tests. If the tests are interrupted, the test data will remain.</p></section></section><section>
<h2><a name="Testing_through_continuous_integration"></a><a name="CI"></a> Testing through continuous integration</h2><section>
<h3><a name="Parallel_CI_builds."></a>Parallel CI builds.</h3>
<p>For CI testing of the module, including the integration tests, it is generally necessary to support testing multiple PRs simultaneously.</p>
<p>To do this 1. A job ID must be supplied in the <code>job.id</code> property, so each job works on an isolated directory tree. This should be a number or unique string, which will be used within a path element, so must only contain characters valid in an S3/hadoop path element. 2. Root directory tests need to be disabled by setting <code>fs.s3a.root.tests.enabled</code> to <code>false</code>, either in the command line to maven or in the XML configurations.</p>

<div class="source">
<div class="source">
<pre>mvn verify -T 1C -Dparallel-tests -DtestsThreadCount=14 -Dscale -Dfs.s3a.root.tests.enabled=false -Djob.id=001
</pre></div></div>

<p>This parallel execution feature is only for isolated builds sharing a single S3 bucket; it does not support parallel builds and tests from the same local source tree.</p>
<p>Without the root tests being executed, set up a scheduled job to purge the test bucket of all data on a regular basis, to keep costs down. The easiest way to do this is to have a bucket lifecycle rule for the bucket to delete all files more than a few days old, alongside one to abort all pending uploads more than 24h old.</p></section><section>
<h3><a name="Securing_CI_builds"></a>Securing CI builds</h3>
<p>It&#x2019;s clearly unsafe to have CI infrastructure testing PRs submitted to apache github account with AWS credentials -which is why it isn&#x2019;t done by the Yetus-initiated builds.</p>
<p>Anyone doing this privately should: * Review incoming patches before triggering the tests. * Have a dedicated IAM role with restricted access to the test bucket, any KMS keys used, and the external bucket containing the CSV test file. * Have a build process which generates short-lived session credentials for this role. * Run the tests in an EC2 VM/container which collects the restricted IAM credentials from the IAM instance/container credentials provider.</p></section></section><section>
<h2><a name="Load_tests."></a><a name="load"></a> Load tests.</h2>
<p>Some tests are designed to overload AWS services with more requests per second than an AWS account is permitted.</p>
<p>The operation of these tests may be observable to other users of the same account -especially if they are working in the AWS region to which the tests are targeted.</p>
<p>There may also run up larger bills.</p>
<p>These tests all have the prefix <code>ILoadTest</code></p>
<p>They do not run automatically: they must be explicitly run from the command line or an IDE.</p>
<p>Look in the source for these and reads the Javadocs before executing.</p>
<p>Note: one fear here was that asking for two many session/role credentials in a short period of time would actually lock an account out of a region. It doesn&#x2019;t: it simply triggers throttling of STS requests.</p></section><section>
<h2><a name="Testing_against_non-AWS_S3_Stores."></a><a name="alternate_s3"></a> Testing against non-AWS S3 Stores.</h2>
<p>The S3A filesystem is designed to work with S3 stores which implement the S3 protocols to the extent that the amazon S3 SDK is capable of talking to it. We encourage testing against other filesystems and submissions of patches which address issues. In particular, we encourage testing of Hadoop release candidates, as these third-party endpoints get even less testing than the S3 endpoint itself.</p>
<p>The core XML settings to turn off tests of features unavailable on third party stores.</p>

<div class="source">
<div class="source">
<pre>  &lt;property&gt;
    &lt;name&gt;test.fs.s3a.encryption.enabled&lt;/name&gt;
    &lt;value&gt;false&lt;/value&gt;
  &lt;/property&gt;
  &lt;property&gt;
    &lt;name&gt;test.fs.s3a.create.storage.class.enabled&lt;/name&gt;
    &lt;value&gt;false&lt;/value&gt;
  &lt;/property&gt;
  &lt;property&gt;
    &lt;name&gt;test.fs.s3a.sts.enabled&lt;/name&gt;
    &lt;value&gt;false&lt;/value&gt;
  &lt;/property&gt;
  &lt;property&gt;
    &lt;name&gt;test.fs.s3a.create.create.acl.enabled&lt;/name&gt;
    &lt;value&gt;false&lt;/value&gt;
  &lt;/property&gt;
</pre></div></div>

<p>See <a href="third_party_stores.html">Third Party Stores</a> for more on this topic.</p><section>
<h3><a name="Public_datasets_used_in_tests"></a>Public datasets used in tests</h3>
<p>Some tests rely on the presence of existing public datasets available on Amazon S3. You may find a number of these in <code>org.apache.hadoop.fs.s3a.test.PublicDatasetTestUtils</code>.</p>
<p>When testing against an endpoint which is not part of Amazon S3&#x2019;s standard commercial partition (<code>aws</code>) such as third-party implementations or AWS&#x2019;s China regions, you should replace these configurations with an empty space (<code></code>) to disable the tests or an existing path in your object store that supports these tests.</p>
<p>An example of this might be the MarkerTools tests which require a bucket with a large number of objects or the requester pays tests that require requester pays to be enabled for the bucket.</p></section><section>
<h3><a name="Disabling_the_storage_class_tests"></a>Disabling the storage class tests</h3>
<p>When running storage class tests against third party object store that doesn&#x2019;t support S3 storage class, these tests might fail. They can be disabled.</p>

<div class="source">
<div class="source">
<pre>&lt;property&gt;
  &lt;name&gt;test.fs.s3a.create.storage.class.enabled&lt;/name&gt;
  &lt;value&gt;false&lt;/value&gt;
&lt;/property&gt;
</pre></div></div>
</section><section>
<h3><a name="Configuring_the_CSV_file_read_tests"></a>Configuring the CSV file read tests</h3>
<p>To test on alternate infrastructures supporting the same APIs, the option <code>fs.s3a.scale.test.csvfile</code> must either be set to &quot; &quot;, or an object of at least 10MB is uploaded to the object store, and the <code>fs.s3a.scale.test.csvfile</code> option set to its path.</p>

<div class="source">
<div class="source">
<pre>&lt;property&gt;
  &lt;name&gt;fs.s3a.scale.test.csvfile&lt;/name&gt;
  &lt;value&gt; &lt;/value&gt;
&lt;/property&gt;
</pre></div></div>

<p>(yes, the space is necessary. The Hadoop <code>Configuration</code> class treats an empty value as &#x201c;do not override the default&#x201d;).</p></section><section>
<h3><a name="Enabling_prefetch_for_all_tests"></a><a name="enabling-prefetch"></a> Enabling prefetch for all tests</h3>
<p>The tests are run with prefetch if the <code>prefetch</code> property is set in the maven build. This can be combined with the scale tests as well.</p>
<p>If <code>ITestS3AContractGetFileStatusV1List</code> fails with any error about unsupported API.</p>

<div class="source">
<div class="source">
<pre>  &lt;property&gt;
    &lt;name&gt;test.fs.s3a.list.v1.enabled&lt;/name&gt;
    &lt;value&gt;false&lt;/value&gt;
  &lt;/property&gt;
</pre></div></div>

<p>Note: there&#x2019;s no equivalent for turning off v2 listing API, which all stores are now required to support.</p></section><section>
<h3><a name="Testing_Requester_Pays"></a>Testing Requester Pays</h3>
<p>By default, the requester pays tests will look for a bucket that exists on Amazon S3 in us-east-1.</p>
<p>If the endpoint does support requester pays, you can specify an alternative object. The test only requires an object of at least a few bytes in order to check that lists and basic reads work.</p>

<div class="source">
<div class="source">
<pre>&lt;property&gt;
  &lt;name&gt;test.fs.s3a.requester.pays.file&lt;/name&gt;
  &lt;value&gt;s3a://my-req-pays-enabled-bucket/on-another-endpoint.json&lt;/value&gt;
&lt;/property&gt;
</pre></div></div>

<p>If the endpoint does not support requester pays, you can also disable the tests by configuring the test URI as a single space.</p>

<div class="source">
<div class="source">
<pre>&lt;property&gt;
  &lt;name&gt;test.fs.s3a.requester.pays.file&lt;/name&gt;
  &lt;value&gt; &lt;/value&gt;
&lt;/property&gt;
</pre></div></div>
</section><section>
<h3><a name="Testing_Session_Credentials"></a>Testing Session Credentials</h3>
<p>Some tests requests a session credentials and assumed role credentials from the AWS Secure Token Service, then use them to authenticate with S3 either directly or via delegation tokens.</p>
<p>If an S3 implementation does not support STS, then these functional test cases must be disabled:</p>

<div class="source">
<div class="source">
<pre>&lt;property&gt;
  &lt;name&gt;test.fs.s3a.sts.enabled&lt;/name&gt;
  &lt;value&gt;false&lt;/value&gt;
&lt;/property&gt;

</pre></div></div>

<p>These tests request a temporary set of credentials from the STS service endpoint. An alternate endpoint may be defined in <code>fs.s3a.assumed.role.sts.endpoint</code>. If this is set, a delegation token region must also be defined: in <code>fs.s3a.assumed.role.sts.endpoint.region</code>. This is useful not just for testing alternative infrastructures, but to reduce latency on tests executed away from the central service.</p>

<div class="source">
<div class="source">
<pre>&lt;property&gt;
  &lt;name&gt;fs.s3a.delegation.token.endpoint&lt;/name&gt;
  &lt;value&gt;fs.s3a.assumed.role.sts.endpoint&lt;/value&gt;
&lt;/property&gt;
&lt;property&gt;
  &lt;name&gt;fs.s3a.assumed.role.sts.endpoint.region&lt;/name&gt;
  &lt;value&gt;eu-west-2&lt;/value&gt;
&lt;/property&gt;
</pre></div></div>

<p>The default is &quot;&quot;; meaning &#x201c;use the amazon default endpoint&#x201d; (<code>sts.amazonaws.com</code>).</p>
<p>Consult the <a class="externalLink" href="https://docs.aws.amazon.com/general/latest/gr/rande.html#sts_region">AWS documentation</a> for the full list of locations.</p></section><section>
<h3><a name="Disabling_Content_Encoding_tests"></a>Disabling Content Encoding tests</h3>
<p>Tests in <code>ITestS3AContentEncoding</code> may need disabling</p>

<div class="source">
<div class="source">
<pre>  &lt;property&gt;
    &lt;name&gt;test.fs.s3a.content.encoding.enabled&lt;/name&gt;
    &lt;value&gt;false&lt;/value&gt;
  &lt;/property&gt;
</pre></div></div>
</section><section>
<h3><a name="Tests_which_may_fail_.28and_which_you_can_ignore.29"></a>Tests which may fail (and which you can ignore)</h3>
<ul>

<li><code>ITestS3AContractMultipartUploader</code> tests <code>testMultipartUploadAbort</code> and <code>testSingleUpload</code> raising <code>FileNotFoundException</code></li>
<li><code>ITestS3AMiscOperations.testEmptyFileChecksums</code>: if the FS encrypts data always.</li>
</ul></section></section><section>
<h2><a name="Debugging_Test_failures"></a><a name="debugging"></a> Debugging Test failures</h2>
<p>Logging at debug level is the standard way to provide more diagnostics output; after setting this rerun the tests</p>

<div class="source">
<div class="source">
<pre>log4j.logger.org.apache.hadoop.fs.s3a=DEBUG
</pre></div></div>

<p>There are also some logging options for debug logging of the AWS client; consult the file.</p>
<p>There is also the option of enabling logging on a bucket; this could perhaps be used to diagnose problems from that end. This isn&#x2019;t something actively used, but remains an option. If you are forced to debug this way, consider setting the <code>fs.s3a.user.agent.prefix</code> to a unique prefix for a specific test run, which will enable the specific log entries to be more easily located.</p></section><section>
<h2><a name="Adding_new_tests"></a><a name="new_tests"></a> Adding new tests</h2>
<p>New tests are always welcome. Bear in mind that we need to keep costs and test time down, which is done by</p>
<ul>

<li>Not duplicating tests.</li>
<li>Being efficient in your use of Hadoop API calls.</li>
<li>Isolating large/slow tests into the &#x201c;scale&#x201d; test group.</li>
<li>Designing all tests to execute in parallel (where possible).</li>
<li>Adding new probes and predicates into existing tests, albeit carefully.</li>
</ul>
<p><i>No duplication</i>: if an operation is tested elsewhere, don&#x2019;t repeat it. This applies as much for metadata operations as it does for bulk IO. If a new test case is added which completely obsoletes an existing test, it is OK to cut the previous one &#x2014;after showing that coverage is not worsened.</p>
<p><i>Efficient</i>: prefer the <code>getFileStatus()</code> and examining the results, rather than call to <code>exists()</code>, <code>isFile()</code>, etc.</p>
<p><i>Isolating Scale tests</i>. Any S3A test doing large amounts of IO MUST extend the class <code>S3AScaleTestBase</code>, so only running if <code>scale</code> is defined on a build, supporting test timeouts configurable by the user. Scale tests should also support configurability as to the actual size of objects/number of operations, so that behavior at different scale can be verified.</p>
<p><i>Designed for parallel execution</i>. A key need here is for each test suite to work on isolated parts of the filesystem. Subclasses of <code>AbstractS3ATestBase</code> SHOULD use the <code>path()</code> method, with a base path of the test suite name, to build isolated paths. Tests MUST NOT assume that they have exclusive access to a bucket.</p>
<p><i>Extending existing tests where appropriate</i>. This recommendation goes against normal testing best practise of &#x201c;test one thing per method&#x201d;. Because it is so slow to create directory trees or upload large files, we do not have that luxury. All the tests against real S3 endpoints are integration tests where sharing test setup and teardown saves time and money.</p>
<p>A standard way to do this is to extend existing tests with some extra predicates, rather than write new tests. When doing this, make sure that the new predicates fail with meaningful diagnostics, so any new problems can be easily debugged from test logs.</p>
<p><b><i>Effective use of FS instances during S3A integration tests.</i></b> Tests using <code>FileSystem</code> instances are fastest if they can recycle the existing FS instance from the same JVM.</p>
<p>If you do that, you MUST NOT close or do unique configuration on them. If you want a guarantee of 100% isolation or an instance with unique config, create a new instance which you MUST close in the teardown to avoid leakage of resources.</p>
<p>Do NOT add <code>FileSystem</code> instances manually (with e.g <code>org.apache.hadoop.fs.FileSystem#addFileSystemForTesting</code>) to the cache that will be modified or closed during the test runs. This can cause other tests to fail when using the same modified or closed FS instance. For more details see HADOOP-15819.</p></section><section>
<h2><a name="Requirements_of_new_Tests"></a><a name="requirements"></a> Requirements of new Tests</h2>
<p>This is what we expect from new tests; they&#x2019;re an extension of the normal Hadoop requirements, based on the need to work with remote servers whose use requires the presence of secret credentials, where tests may be slow, and where finding out why something failed from nothing but the test output is critical.</p><section>
<h3><a name="Subclasses_Existing_Shared_Base_Classes"></a>Subclasses Existing Shared Base Classes</h3>
<p>Extend <code>AbstractS3ATestBase</code> or <code>AbstractSTestS3AHugeFiles</code> unless justifiable. These set things up for testing against the object stores, provide good threadnames, help generate isolated paths, and for <code>AbstractSTestS3AHugeFiles</code> subclasses, only run if <code>-Dscale</code> is set.</p>
<p>Key features of <code>AbstractS3ATestBase</code></p>
<ul>

<li><code>getFileSystem()</code> returns the S3A Filesystem bonded to the contract test Filesystem defined in <code>fs.s3a.contract.test</code></li>
<li>will automatically skip all tests if that URL is unset.</li>
<li>Extends  <code>AbstractFSContractTestBase</code> and <code>Assert</code> for all their methods.</li>
</ul>
<p>Having shared base classes may help reduce future maintenance too. Please use them/</p></section><section>
<h3><a name="Secure"></a>Secure</h3>
<p>Don&#x2019;t ever log credentials. The credential tests go out of their way to not provide meaningful logs or assertion messages precisely to avoid this.</p></section><section>
<h3><a name="Efficient_of_Time_and_Money"></a>Efficient of Time and Money</h3>
<p>This means efficient in test setup/teardown, and, ideally, making use of existing public datasets to save setup time and tester cost.</p>
<p>Strategies of particular note are:</p>
<ol style="list-style-type: decimal">

<li><code>ITestS3ADirectoryPerformance</code>: a single test case sets up the directory tree then performs different list operations, measuring the time taken.</li>
<li><code>AbstractSTestS3AHugeFiles</code>: marks the test suite as <code>@FixMethodOrder(MethodSorters.NAME_ASCENDING)</code> then orders the test cases such that each test case expects the previous test to have completed (here: uploaded a file, renamed a file, &#x2026;). This provides for independent tests in the reports, yet still permits an ordered sequence of operations. Do note the use of <code>Assume.assume()</code> to detect when the preconditions for a single test case are not met, hence, the tests become skipped, rather than fail with a trace which is really a false alarm.</li>
</ol>
<p>The ordered test case mechanism of <code>AbstractSTestS3AHugeFiles</code> is probably the most elegant way of chaining test setup/teardown.</p>
<p>Regarding reusing existing data, we tend to use the noaa-cors-pds archive of AWS US-East for our testing of input stream operations. This doesn&#x2019;t work against other regions, or with third party S3 implementations. Thus the URL can be overridden for testing elsewhere.</p></section><section>
<h3><a name="Works_With_Other_S3_Stored"></a>Works With Other S3 Stored</h3>
<p>Don&#x2019;t assume AWS S3 US-East only, do allow for working with external S3 implementations. Those may be behind the latest S3 API features, not support encryption, session APIs, etc.</p>
<p>They won&#x2019;t have the same CSV/large test files as some of the input tests rely on. Look at <code>ITestS3AInputStreamPerformance</code> to see how tests can be written to support the declaration of a specific large test file on alternate filesystems.</p></section><section>
<h3><a name="Works_Over_Long-haul_Links"></a>Works Over Long-haul Links</h3>
<p>As well as making file size and operation counts scalable, this includes making test timeouts adequate. The Scale tests make this configurable; it&#x2019;s hard coded to ten minutes in <code>AbstractS3ATestBase()</code>; subclasses can change this by overriding <code>getTestTimeoutMillis()</code>.</p>
<p>Equally importantly: support proxies, as some testers need them.</p></section><section>
<h3><a name="Provides_Diagnostics_and_timing_information"></a>Provides Diagnostics and timing information</h3>
<ol style="list-style-type: decimal">

<li>Give threads useful names.</li>
<li>Create logs, log things. Know that the <code>S3AFileSystem</code> and its input and output streams <i>all</i> provide useful statistics in their {{toString()}} calls; logging them is useful on its own.</li>
<li>you can use <code>AbstractS3ATestBase.describe(format-stringm, args)</code> here.; it adds some newlines so as to be easier to spot.</li>
<li>Use <code>ContractTestUtils.NanoTimer</code> to measure the duration of operations, and log the output.</li>
</ol></section><section>
<h3><a name="Fails_Meaningfully"></a>Fails Meaningfully</h3>
<p>The <code>ContractTestUtils</code> class contains a whole set of assertions for making statements about the expected state of a filesystem, e.g. <code>assertPathExists(FS, path)</code>, <code>assertPathDoesNotExists(FS, path)</code>, and others. These do their best to provide meaningful diagnostics on failures (e.g. directory listings, file status, &#x2026;), so help make failures easier to understand.</p>
<p>At the very least, do not use <code>assertTrue()</code> or <code>assertFalse()</code> without including error messages.</p></section><section>
<h3><a name="Sets_up_its_filesystem_and_checks_for_those_settings"></a>Sets up its filesystem and checks for those settings</h3>
<p>Tests can overrun <code>createConfiguration()</code> to add new options to the configuration file for the S3A Filesystem instance used in their tests.</p>
<p>However, filesystem caching may mean that a test suite may get a cached instance created with an different configuration. For tests which don&#x2019;t need specific configurations caching is good: it reduces test setup time.</p>
<p>For those tests which do need unique options (encryption, magic files), things can break, and they will do so in hard-to-replicate ways.</p>
<p>Use <code>S3ATestUtils.disableFilesystemCaching(conf)</code> to disable caching when modifying the config. As an example from <code>AbstractTestS3AEncryption</code>:</p>

<div class="source">
<div class="source">
<pre>@Override
protected Configuration createConfiguration() {
  Configuration conf = super.createConfiguration();
  S3ATestUtils.disableFilesystemCaching(conf);
  removeBaseAndBucketOverrides(conf,
      SERVER_SIDE_ENCRYPTION_ALGORITHM);  
  conf.set(Constants.SERVER_SIDE_ENCRYPTION_ALGORITHM,
          getSSEAlgorithm().getMethod());
  return conf;
}
</pre></div></div>

<p>Then verify in the setup method or test cases that their filesystem actually has the desired feature (<code>fs.getConf().getProperty(...)</code>). This not only catches filesystem reuse problems, it catches the situation where the filesystem configuration in <code>auth-keys.xml</code> has explicit per-bucket settings which override the test suite&#x2019;s general option settings.</p></section><section>
<h3><a name="Cleans_Up_Afterwards"></a>Cleans Up Afterwards</h3>
<p>Keeps costs down.</p>
<ol style="list-style-type: decimal">

<li>Do not only cleanup if a test case completes successfully; test suite teardown must do it.</li>
<li>That teardown code must check for the filesystem and other fields being null before the cleanup. Why? If test setup fails, the teardown methods still get called.</li>
</ol></section><section>
<h3><a name="Works_Reliably"></a>Works Reliably</h3>
<p>We really appreciate this &#x2014; you will too.</p></section><section>
<h3><a name="Runs_in_parallel_unless_this_is_unworkable."></a>Runs in parallel unless this is unworkable.</h3>
<p>Tests must be designed to run in parallel with other tests, all working with the same shared S3 bucket. This means</p>
<ul>

<li>Uses relative and JVM-fork-unique paths provided by the method <code>AbstractFSContractTestBase.path(String filepath)</code>.</li>
<li>Doesn&#x2019;t manipulate the root directory or make assertions about its contents (for example: delete its contents and assert that it is now empty).</li>
<li>Doesn&#x2019;t have a specific requirement of all active clients of the bucket (example: SSE-C tests which require all files, even directory markers, to be encrypted with the same key).</li>
<li>Doesn&#x2019;t use so much bandwidth that all other tests will be starved of IO and start timing out (e.g. the scale tests).</li>
</ul>
<p>Tests such as these can only be run as sequential tests. When adding one, exclude it in the POM file. from the parallel failsafe run and add to the sequential one afterwards. The IO heavy ones must also be subclasses of <code>S3AScaleTestBase</code> and so only run if the system/maven property <code>fs.s3a.scale.test.enabled</code> is true.</p></section><section>
<h3><a name="Individual_test_cases_can_be_run_in_an_IDE"></a>Individual test cases can be run in an IDE</h3>
<p>This is invaluable for debugging test failures.</p>
<p>How to set test options in your hadoop configuration rather than on the maven command line:</p></section><section>
<h3><a name="Keeping_AWS_Costs_down"></a>Keeping AWS Costs down</h3>
<p>Most of the base S3 tests are designed delete files after test runs, so you don&#x2019;t have to pay for storage costs. The scale tests do work with more data so will cost more as well as generally take more time to execute.</p>
<p>You are however billed for</p>
<ol style="list-style-type: decimal">

<li>Data left in S3 after test runs.</li>
<li>HTTP operations on files (HEAD, LIST, GET).</li>
<li>In-progress multipart uploads from bulk IO or S3A committer tests.</li>
<li>Encryption/decryption using AWS KMS keys.</li>
</ol>
<p>The GET/decrypt costs are incurred on each partial read of a file, so random IO can cost more than sequential IO; the speedup of queries with columnar data usually justifies this.</p>
<p>How to keep costs down</p>
<ul>

<li>Don&#x2019;t run the scale tests with large datasets; keep <code>fs.s3a.scale.test.huge.filesize</code> unset, or a few MB (minimum: 5).</li>
<li>Remove all files in the filesystem. The root tests usually do this, but it can be manually done:
<p>*hadoop fs -rm -r -f -skipTrash <a class="externalLink" href="s3a://test-bucket/">s3a://test-bucket/</a></p></li>
<li>Abort all outstanding uploads:
<p>hadoop s3guard uploads -abort -force <a class="externalLink" href="s3a://test-bucket/">s3a://test-bucket/</a></p></li>
</ul></section></section><section>
<h2><a name="Tips"></a><a name="tips"></a> Tips</h2><section>
<h3><a name="How_to_keep_your_credentials_really_safe"></a>How to keep your credentials really safe</h3>
<p>Although the <code>auth-keys.xml</code> file is marked as ignored in git and subversion, it is still in your source tree, and there&#x2019;s always that risk that it may creep out.</p>
<p>You can avoid this by keeping your keys outside the source tree and using an absolute XInclude reference to it.</p>

<div class="source">
<div class="source">
<pre>&lt;configuration&gt;

  &lt;include xmlns=&quot;http://www.w3.org/2001/XInclude&quot;
    href=&quot;file:///users/ubuntu/.auth-keys.xml&quot; /&gt;

&lt;/configuration&gt;
</pre></div></div>
</section></section><section>
<h2><a name="Failure_Injection"></a><a name="failure-injection"></a>Failure Injection</h2>
<p>S3A provides an &#x201c;Inconsistent S3 Client Factory&#x201d; that can be used to simulate throttling by injecting random failures on S3 client requests.</p>
<p><b>Note</b></p>
<p>In previous releases, this factory could also be used to simulate inconsistencies during testing of S3Guard. Now that S3 is consistent, injecting inconsistency is no longer needed during testing.</p></section><section>
<h2><a name="Testing_Assumed_Roles"></a><a name="assumed_roles"></a> Testing Assumed Roles</h2>
<p>Tests for the AWS Assumed Role credential provider require an assumed role to request.</p>
<p>If this role is not declared in <code>fs.s3a.assumed.role.arn</code>, the tests which require it will be skipped.</p>
<p>The specific tests an Assumed Role ARN is required for are</p>
<ul>

<li><code>ITestAssumeRole</code>.</li>
<li><code>ITestRoleDelegationTokens</code>.</li>
<li>One of the parameterized test cases in <code>ITestDelegatedMRJob</code>.</li>
</ul>
<p>To run these tests you need:</p>
<ol style="list-style-type: decimal">

<li>

<p>A role in your AWS account will full read and write access rights to the S3 bucket used in the tests, and KMS for any SSE-KMS or DSSE-KMS tests.</p>
</li>
<li>

<p>Your IAM User to have the permissions to &#x201c;assume&#x201d; that role.</p>
</li>
<li>

<p>The role ARN must be set in <code>fs.s3a.assumed.role.arn</code>.</p>
</li>
</ol>

<div class="source">
<div class="source">
<pre>&lt;property&gt;
  &lt;name&gt;fs.s3a.assumed.role.arn&lt;/name&gt;
  &lt;value&gt;arn:aws:iam::9878543210123:role/role-s3-restricted&lt;/value&gt;
&lt;/property&gt;
</pre></div></div>

<p>The tests assume the role with different subsets of permissions and verify that the S3A client (mostly) works when the caller has only write access to part of the directory tree.</p>
<p>You can also run the entire test suite in an assumed role, a more thorough test, by switching to the credentials provider.</p>

<div class="source">
<div class="source">
<pre>&lt;property&gt;
  &lt;name&gt;fs.s3a.aws.credentials.provider&lt;/name&gt;
  &lt;value&gt;org.apache.hadoop.fs.s3a.auth.AssumedRoleCredentialProvider&lt;/value&gt;
&lt;/property&gt;
</pre></div></div>

<p>The usual credentials needed to log in to the bucket will be used, but now the credentials used to interact with S3 will be temporary role credentials, rather than the full credentials.</p></section><section>
<h2><a name="Qualifying_an_AWS_SDK_Update"></a><a name="qualifying_sdk_updates"></a> Qualifying an AWS SDK Update</h2>
<p>Updating the AWS SDK is something which does need to be done regularly, but is rarely without complications, major or minor.</p>
<p>Assume that the version of the SDK will remain constant for an X.Y release, excluding security fixes, so it&#x2019;s good to have an update before each release &#x2014; as long as that update works doesn&#x2019;t trigger any regressions.</p>
<ol style="list-style-type: decimal">

<li>Don&#x2019;t make this a last minute action.</li>
<li>The upgrade patch should focus purely on the SDK update, so it can be cherry picked and reverted easily.</li>
<li>Do not mix in an SDK update with any other piece of work, for the same reason.</li>
<li>Plan for an afternoon&#x2019;s work, including before/after testing, log analysis and any manual tests.</li>
<li>Make sure all the integration tests are running (including ARN, encryption, scale) <i>before you start the upgrade</i>.</li>
<li>Create a JIRA for updating the SDK. Don&#x2019;t include the version (yet), as it may take a couple of SDK updates before it is ready.</li>
<li>Identify the latest AWS SDK <a class="externalLink" href="https://aws.amazon.com/sdk-for-java/">available for download</a>.</li>
<li>Create a private git branch of trunk for JIRA, and in <code>hadoop-project/pom.xml</code> update the <code>aws-java-sdk.version</code> to the new SDK version.</li>
<li>Update AWS SDK versions in NOTICE.txt and LICENSE.binary</li>
<li>Do a clean build and rerun all the <code>hadoop-aws</code> tests. This includes the <code>-Pscale</code> set, with a role defined for the assumed role tests. in <code>fs.s3a.assumed.role.arn</code> for testing assumed roles, and <code>fs.s3a.encryption.key</code> for encryption, for full coverage. If you can, scale up the scale tests.</li>
<li>Create an Access Point for your bucket (using the AWS Console or CLI), update S3a configuration to use it (<a href="./index.html#accesspoints">docs for help</a>) and re-run the <code>ITest*</code> integration tests from your IDE or via maven.</li>
<li>Run the <code>ILoadTest*</code> load tests from your IDE or via maven through <code>mvn verify -Dtest=skip -Dit.test=ILoadTest\*</code>  ; look for regressions in performance as much as failures.</li>
<li>Create the site with <code>mvn site -DskipTests</code>; look in <code>target/site</code> for the report.</li>
<li>Review *every single <code>-output.txt</code> file in <code>hadoop-tools/hadoop-aws/target/failsafe-reports</code>, paying particular attention to <code>org.apache.hadoop.fs.s3a.scale.ITestS3AInputStreamPerformance-output.txt</code>, as that is where changes in stream close/abort logic will surface.</li>
<li>Run <code>mvn install</code> to install the artifacts, then in <code>hadoop-cloud-storage-project/hadoop-cloud-storage</code> run <code>mvn dependency:tree -Dverbose &gt; target/dependencies.txt</code>. Examine the <code>target/dependencies.txt</code> file to verify that no new artifacts have unintentionally been declared as dependencies of the shaded <code>software.amazon.awssdk:bundle:jar</code> artifact.</li>
<li>Run a full AWS-test suite with S3 client-side encryption enabled by setting <code>fs.s3a.encryption.algorithm</code> to &#x2018;CSE-KMS&#x2019; and setting up AWS-KMS Key ID in <code>fs.s3a.encryption.key</code>.</li>
<li>Verify that the output of test <code>TestAWSV2SDK</code> doesn&#x2019;t contain any unshaded classes.</li>
</ol>
<p>The dependency chain of the <code>hadoop-aws</code> module should be similar to this, albeit with different version numbers:</p>

<div class="source">
<div class="source">
<pre>[INFO] +- org.apache.hadoop:hadoop-aws:jar:3.4.0-SNAPSHOT:compile
[INFO] |  +- software.amazon.awssdk:bundle:jar:2.23.5:compile
[INFO] |  \- org.wildfly.openssl:wildfly-openssl:jar:1.1.3.Final:compile
</pre></div></div>
<section>
<h3><a name="Basic_command_line_regression_testing"></a>Basic command line regression testing</h3>
<p>We need a run through of the CLI to see if there have been changes there which cause problems, especially whether new log messages have surfaced, or whether some packaging change breaks that CLI.</p>
<p>It is always interesting when doing this to enable IOStatistics reporting</p>

<div class="source">
<div class="source">
<pre>&lt;property&gt;
  &lt;name&gt;fs.iostatistics.logging.level&lt;/name&gt;
  &lt;value&gt;info&lt;/value&gt;
&lt;/property&gt;
</pre></div></div>

<p>From the root of the project, create a command line release <code>mvn package -Pdist -DskipTests -Dmaven.javadoc.skip=true -DskipShade</code>;</p>
<ol style="list-style-type: decimal">

<li>Change into the <code>hadoop-dist/target/hadoop-x.y.z-SNAPSHOT</code> dir.</li>
<li>Copy a <code>core-site.xml</code> file into <code>etc/hadoop</code>.</li>
<li>Set the <code>HADOOP_OPTIONAL_TOOLS</code> env var on the command line or <code>~/.hadoop-env</code>.</li>
</ol>

<div class="source">
<div class="source">
<pre>export HADOOP_OPTIONAL_TOOLS=&quot;hadoop-aws&quot;
</pre></div></div>

<p>Run some basic s3guard CLI as well as file operations.</p>

<div class="source">
<div class="source">
<pre>export BUCKETNAME=example-bucket-name
export BUCKET=s3a://$BUCKETNAME

bin/hadoop s3guard bucket-info $BUCKET

bin/hadoop s3guard uploads $BUCKET
# repeat twice, once with &quot;no&quot; and once with &quot;yes&quot; as responses
bin/hadoop s3guard uploads -abort $BUCKET

# ---------------------------------------------------
# root filesystem operatios
# ---------------------------------------------------

bin/hadoop fs -ls $BUCKET/
# assuming file is not yet created, expect error and status code of 1
bin/hadoop fs -ls $BUCKET/file

# exit code of 0 even when path doesn't exist
bin/hadoop fs -rm -R -f $BUCKET/dir-no-trailing
bin/hadoop fs -rm -R -f $BUCKET/dir-trailing/

# error because it is a directory
bin/hadoop fs -rm $BUCKET/

bin/hadoop fs -touchz $BUCKET/file
# expect I/O error as it is the root directory
bin/hadoop fs -rm -r $BUCKET/

# succeeds
bin/hadoop fs -rm -r $BUCKET/\*

# ---------------------------------------------------
# File operations
# ---------------------------------------------------

bin/hadoop fs -mkdir $BUCKET/dir-no-trailing
bin/hadoop fs -mkdir $BUCKET/dir-trailing/
bin/hadoop fs -touchz $BUCKET/file
bin/hadoop fs -ls $BUCKET/
bin/hadoop fs -mv $BUCKET/file $BUCKET/file2
# expect &quot;No such file or directory&quot;
bin/hadoop fs -stat $BUCKET/file

# expect success
bin/hadoop fs -stat $BUCKET/file2

# expect &quot;file exists&quot;
bin/hadoop fs -mkdir $BUCKET/dir-no-trailing
bin/hadoop fs -mv $BUCKET/file2 $BUCKET/dir-no-trailing
bin/hadoop fs -stat $BUCKET/dir-no-trailing/file2
# treated the same as the file stat
bin/hadoop fs -stat $BUCKET/dir-no-trailing/file2/
bin/hadoop fs -ls $BUCKET/dir-no-trailing/file2/
bin/hadoop fs -ls $BUCKET/dir-no-trailing
# expect a &quot;0&quot; here:
bin/hadoop fs -test -d  $BUCKET/dir-no-trailing ; echo $?
# expect a &quot;1&quot; here:
bin/hadoop fs -test -d  $BUCKET/dir-no-trailing/file2 ; echo $?
# will return NONE unless bucket has checksums enabled
bin/hadoop fs -checksum $BUCKET/dir-no-trailing/file2
# expect &quot;etag&quot; + a long string
bin/hadoop fs -D fs.s3a.etag.checksum.enabled=true -checksum $BUCKET/dir-no-trailing/file2
bin/hadoop fs -expunge -immediate -fs $BUCKET

# ---------------------------------------------------
# Delegation Token support
# ---------------------------------------------------

# failure unless delegation tokens are enabled
bin/hdfs fetchdt --webservice $BUCKET secrets.bin
# success
bin/hdfs fetchdt -D fs.s3a.delegation.token.binding=org.apache.hadoop.fs.s3a.auth.delegation.SessionTokenBinding --webservice $BUCKET secrets.bin
bin/hdfs fetchdt -print secrets.bin

# expect warning &quot;No TokenRenewer defined for token kind S3ADelegationToken/Session&quot;
bin/hdfs fetchdt -renew secrets.bin


# ---------------------------------------------------
# Copy to from local
# ---------------------------------------------------

time bin/hadoop fs -copyFromLocal -t 10  share/hadoop/tools/lib/*aws*jar $BUCKET/

# expect the iostatistics object_list_request value to be O(directories)
bin/hadoop fs -ls -R $BUCKET/

# expect the iostatistics object_list_request and op_get_content_summary values to be 1
bin/hadoop fs -du -h -s $BUCKET/

mkdir tmp
time bin/hadoop fs -copyToLocal -t 10  $BUCKET/\*aws\* tmp

# ---------------------------------------------------
# Cloudstore
# check out and build https://github.com/steveloughran/cloudstore
# then for these tests, set CLOUDSTORE env var to point to the JAR
# ---------------------------------------------------

bin/hadoop jar $CLOUDSTORE storediag $BUCKET

time bin/hadoop jar $CLOUDSTORE bandwidth 64M $BUCKET/testfile

</pre></div></div>
</section><section>
<h3><a name="Other_tests"></a>Other tests</h3>
<ul>

<li>Whatever applications you have which use S3A: build and run them before the upgrade, Then see if complete successfully in roughly the same time once the upgrade is applied.</li>
<li>Test any third-party endpoints you have access to.</li>
<li>Try different regions (especially a v4 only region), and encryption settings.</li>
<li>Any performance tests you have can identify slowdowns, which can be a sign of changed behavior in the SDK (especially on stream reads and writes).</li>
<li>If you can, try to test in an environment where a proxy is needed to talk to AWS services.</li>
<li>Try and get other people, especially anyone with their own endpoints, apps or different deployment environments, to run their own tests.</li>
<li>Run the load tests, especially <code>ILoadTestS3ABulkDeleteThrottling</code>.</li>
<li>Checkout cloudstore, build it against your version of hadoop, then use its CLI to run some commands (<code>storediag</code> etc)</li>
</ul></section><section>
<h3><a name="Dealing_with_Deprecated_APIs_and_New_Features"></a>Dealing with Deprecated APIs and New Features</h3>
<p>A Jenkins run should tell you if there are new deprecations. If so, you should think about how to deal with them.</p>
<p>Moving to methods and APIs which weren&#x2019;t in the previous SDK release makes it harder to roll back if there is a problem; but there may be good reasons for the deprecation.</p>
<p>At the same time, there may be good reasons for staying with the old code.</p>
<ul>

<li>AWS have embraced the builder pattern for new operations; note that objects constructed this way often have their (existing) setter methods disabled; this may break existing code.</li>
<li>New versions of S3 calls (list v2, bucket existence checks, bulk operations) may be better than the previous HTTP operations &amp; APIs, but they may not work with third-party endpoints, so can only be adopted if made optional, which then adds a new configuration option (with docs, testing, &#x2026;). A change like that must be done in its own patch, with its new tests which compare the old vs new operations.</li>
</ul></section><section>
<h3><a name="Committing_the_patch"></a>Committing the patch</h3>
<p>When the patch is committed: update the JIRA to the version number actually used; use that title in the commit message.</p>
<p>Be prepared to roll-back, re-iterate or code your way out of a regression.</p>
<p>There may be some problem which surfaces with wider use, which can get fixed in a new AWS release, rolling back to an older one, or just worked around <a class="externalLink" href="https://issues.apache.org/jira/browse/HADOOP-14596">HADOOP-14596</a>.</p>
<p>Don&#x2019;t be surprised if this happens, don&#x2019;t worry too much, and, while that rollback option is there to be used, ideally try to work forwards.</p>
<p>If the problem is with the SDK, file issues with the <a class="externalLink" href="https://github.com/aws/aws-sdk-java-v2/issues">AWS V2 SDK Bug tracker</a>. If the problem can be fixed or worked around in the Hadoop code, do it there too.</p></section></section>
      </div>
    </div>
    <div class="clear">
      <hr/>
    </div>
    <div id="footer">
      <div class="xright">
        &#169;            2008-2024
              Apache Software Foundation
            
                          - <a href="http://maven.apache.org/privacy-policy.html">Privacy Policy</a>.
        Apache Maven, Maven, Apache, the Apache feather logo, and the Apache Maven project logos are trademarks of The Apache Software Foundation.
      </div>
      <div class="clear">
        <hr/>
      </div>
    </div>
  </body>
</html>
