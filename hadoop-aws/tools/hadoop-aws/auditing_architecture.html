<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<!--
 | Generated by Apache Maven Doxia at 2024-10-22
 | Rendered using Apache Maven Stylus Skin 1.5
-->
<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <title>Apache Hadoop Amazon Web Services support &#x2013; Object Store Auditing: Architecture</title>
    <style type="text/css" media="all">
      @import url("../../css/maven-base.css");
      @import url("../../css/maven-theme.css");
      @import url("../../css/site.css");
    </style>
    <link rel="stylesheet" href="../../css/print.css" type="text/css" media="print" />
        <meta name="Date-Revision-yyyymmdd" content="20241022" />
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
                </head>
  <body class="composite">
    <div id="banner">
                        <a href="http://hadoop.apache.org/" id="bannerLeft">
                                        <img src="http://hadoop.apache.org/images/hadoop-logo.jpg" alt="" />
                </a>
                              <a href="http://www.apache.org/" id="bannerRight">
                                        <img src="http://www.apache.org/images/asf_logo_wide.png" alt="" />
                </a>
            <div class="clear">
        <hr/>
      </div>
    </div>
    <div id="breadcrumbs">
            
                                     <div class="xright">            <a href="http://wiki.apache.org/hadoop" class="externalLink">Wiki</a>
            |
                <a href="https://gitbox.apache.org/repos/asf/hadoop.git" class="externalLink">git</a>
              
                                   &nbsp;| Last Published: 2024-10-22
              &nbsp;| Version: 3.5.0-SNAPSHOT
            </div>
      <div class="clear">
        <hr/>
      </div>
    </div>
    <div id="leftColumn">
      <div id="navcolumn">
             
                                                   <h5>General</h5>
                  <ul>
                  <li class="none">
                  <a href="../../../index.html">Overview</a>
            </li>
                  <li class="none">
                  <a href="../../../hadoop-project-dist/hadoop-common/SingleCluster.html">Single Node Setup</a>
            </li>
                  <li class="none">
                  <a href="../../../hadoop-project-dist/hadoop-common/ClusterSetup.html">Cluster Setup</a>
            </li>
                  <li class="none">
                  <a href="../../../hadoop-project-dist/hadoop-common/CommandsManual.html">Commands Reference</a>
            </li>
                  <li class="none">
                  <a href="../../../hadoop-project-dist/hadoop-common/FileSystemShell.html">FileSystem Shell</a>
            </li>
                  <li class="none">
                  <a href="../../../hadoop-project-dist/hadoop-common/Compatibility.html">Compatibility Specification</a>
            </li>
                  <li class="none">
                  <a href="../../../hadoop-project-dist/hadoop-common/DownstreamDev.html">Downstream Developer's Guide</a>
            </li>
                  <li class="none">
                  <a href="../../../hadoop-project-dist/hadoop-common/AdminCompatibilityGuide.html">Admin Compatibility Guide</a>
            </li>
                  <li class="none">
                  <a href="../../../hadoop-project-dist/hadoop-common/InterfaceClassification.html">Interface Classification</a>
            </li>
                  <li class="none">
                  <a href="../../../hadoop-project-dist/hadoop-common/filesystem/index.html">FileSystem Specification</a>
            </li>
          </ul>
                       <h5>Common</h5>
                  <ul>
                  <li class="none">
                  <a href="../../../hadoop-project-dist/hadoop-common/CLIMiniCluster.html">CLI Mini Cluster</a>
            </li>
                  <li class="none">
                  <a href="../../../hadoop-project-dist/hadoop-common/FairCallQueue.html">Fair Call Queue</a>
            </li>
                  <li class="none">
                  <a href="../../../hadoop-project-dist/hadoop-common/NativeLibraries.html">Native Libraries</a>
            </li>
                  <li class="none">
                  <a href="../../../hadoop-project-dist/hadoop-common/Superusers.html">Proxy User</a>
            </li>
                  <li class="none">
                  <a href="../../../hadoop-project-dist/hadoop-common/RackAwareness.html">Rack Awareness</a>
            </li>
                  <li class="none">
                  <a href="../../../hadoop-project-dist/hadoop-common/SecureMode.html">Secure Mode</a>
            </li>
                  <li class="none">
                  <a href="../../../hadoop-project-dist/hadoop-common/ServiceLevelAuth.html">Service Level Authorization</a>
            </li>
                  <li class="none">
                  <a href="../../../hadoop-project-dist/hadoop-common/HttpAuthentication.html">HTTP Authentication</a>
            </li>
                  <li class="none">
                  <a href="../../../hadoop-project-dist/hadoop-common/CredentialProviderAPI.html">Credential Provider API</a>
            </li>
                  <li class="none">
                  <a href="../../../hadoop-kms/index.html">Hadoop KMS</a>
            </li>
                  <li class="none">
                  <a href="../../../hadoop-project-dist/hadoop-common/Tracing.html">Tracing</a>
            </li>
                  <li class="none">
                  <a href="../../../hadoop-project-dist/hadoop-common/UnixShellGuide.html">Unix Shell Guide</a>
            </li>
                  <li class="none">
                  <a href="../../../hadoop-project-dist/hadoop-common/registry/index.html">Registry</a>
            </li>
                  <li class="none">
                  <a href="../../../hadoop-project-dist/hadoop-common/AsyncProfilerServlet.html">Async Profiler</a>
            </li>
          </ul>
                       <h5>HDFS</h5>
                  <ul>
                  <li class="none">
                  <a href="../../../hadoop-project-dist/hadoop-hdfs/HdfsDesign.html">Architecture</a>
            </li>
                  <li class="none">
                  <a href="../../../hadoop-project-dist/hadoop-hdfs/HdfsUserGuide.html">User Guide</a>
            </li>
                  <li class="none">
                  <a href="../../../hadoop-project-dist/hadoop-hdfs/HDFSCommands.html">Commands Reference</a>
            </li>
                  <li class="none">
                  <a href="../../../hadoop-project-dist/hadoop-hdfs/HDFSHighAvailabilityWithQJM.html">NameNode HA With QJM</a>
            </li>
                  <li class="none">
                  <a href="../../../hadoop-project-dist/hadoop-hdfs/HDFSHighAvailabilityWithNFS.html">NameNode HA With NFS</a>
            </li>
                  <li class="none">
                  <a href="../../../hadoop-project-dist/hadoop-hdfs/ObserverNameNode.html">Observer NameNode</a>
            </li>
                  <li class="none">
                  <a href="../../../hadoop-project-dist/hadoop-hdfs/Federation.html">Federation</a>
            </li>
                  <li class="none">
                  <a href="../../../hadoop-project-dist/hadoop-hdfs/ViewFs.html">ViewFs</a>
            </li>
                  <li class="none">
                  <a href="../../../hadoop-project-dist/hadoop-hdfs/ViewFsOverloadScheme.html">ViewFsOverloadScheme</a>
            </li>
                  <li class="none">
                  <a href="../../../hadoop-project-dist/hadoop-hdfs/HdfsSnapshots.html">Snapshots</a>
            </li>
                  <li class="none">
                  <a href="../../../hadoop-project-dist/hadoop-hdfs/HdfsEditsViewer.html">Edits Viewer</a>
            </li>
                  <li class="none">
                  <a href="../../../hadoop-project-dist/hadoop-hdfs/HdfsImageViewer.html">Image Viewer</a>
            </li>
                  <li class="none">
                  <a href="../../../hadoop-project-dist/hadoop-hdfs/HdfsPermissionsGuide.html">Permissions and HDFS</a>
            </li>
                  <li class="none">
                  <a href="../../../hadoop-project-dist/hadoop-hdfs/HdfsQuotaAdminGuide.html">Quotas and HDFS</a>
            </li>
                  <li class="none">
                  <a href="../../../hadoop-project-dist/hadoop-hdfs/LibHdfs.html">libhdfs (C API)</a>
            </li>
                  <li class="none">
                  <a href="../../../hadoop-project-dist/hadoop-hdfs/WebHDFS.html">WebHDFS (REST API)</a>
            </li>
                  <li class="none">
                  <a href="../../../hadoop-hdfs-httpfs/index.html">HttpFS</a>
            </li>
                  <li class="none">
                  <a href="../../../hadoop-project-dist/hadoop-hdfs/ShortCircuitLocalReads.html">Short Circuit Local Reads</a>
            </li>
                  <li class="none">
                  <a href="../../../hadoop-project-dist/hadoop-hdfs/CentralizedCacheManagement.html">Centralized Cache Management</a>
            </li>
                  <li class="none">
                  <a href="../../../hadoop-project-dist/hadoop-hdfs/HdfsNfsGateway.html">NFS Gateway</a>
            </li>
                  <li class="none">
                  <a href="../../../hadoop-project-dist/hadoop-hdfs/HdfsRollingUpgrade.html">Rolling Upgrade</a>
            </li>
                  <li class="none">
                  <a href="../../../hadoop-project-dist/hadoop-hdfs/ExtendedAttributes.html">Extended Attributes</a>
            </li>
                  <li class="none">
                  <a href="../../../hadoop-project-dist/hadoop-hdfs/TransparentEncryption.html">Transparent Encryption</a>
            </li>
                  <li class="none">
                  <a href="../../../hadoop-project-dist/hadoop-hdfs/HdfsMultihoming.html">Multihoming</a>
            </li>
                  <li class="none">
                  <a href="../../../hadoop-project-dist/hadoop-hdfs/ArchivalStorage.html">Storage Policies</a>
            </li>
                  <li class="none">
                  <a href="../../../hadoop-project-dist/hadoop-hdfs/MemoryStorage.html">Memory Storage Support</a>
            </li>
                  <li class="none">
                  <a href="../../../hadoop-project-dist/hadoop-hdfs/SLGUserGuide.html">Synthetic Load Generator</a>
            </li>
                  <li class="none">
                  <a href="../../../hadoop-project-dist/hadoop-hdfs/HDFSErasureCoding.html">Erasure Coding</a>
            </li>
                  <li class="none">
                  <a href="../../../hadoop-project-dist/hadoop-hdfs/HDFSDiskbalancer.html">Disk Balancer</a>
            </li>
                  <li class="none">
                  <a href="../../../hadoop-project-dist/hadoop-hdfs/HdfsUpgradeDomain.html">Upgrade Domain</a>
            </li>
                  <li class="none">
                  <a href="../../../hadoop-project-dist/hadoop-hdfs/HdfsDataNodeAdminGuide.html">DataNode Admin</a>
            </li>
                  <li class="none">
                  <a href="../../../hadoop-project-dist/hadoop-hdfs-rbf/HDFSRouterFederation.html">Router Federation</a>
            </li>
                  <li class="none">
                  <a href="../../../hadoop-project-dist/hadoop-hdfs/HdfsProvidedStorage.html">Provided Storage</a>
            </li>
          </ul>
                       <h5>MapReduce</h5>
                  <ul>
                  <li class="none">
                  <a href="../../../hadoop-mapreduce-client/hadoop-mapreduce-client-core/MapReduceTutorial.html">Tutorial</a>
            </li>
                  <li class="none">
                  <a href="../../../hadoop-mapreduce-client/hadoop-mapreduce-client-core/MapredCommands.html">Commands Reference</a>
            </li>
                  <li class="none">
                  <a href="../../../hadoop-mapreduce-client/hadoop-mapreduce-client-core/MapReduce_Compatibility_Hadoop1_Hadoop2.html">Compatibility with 1.x</a>
            </li>
                  <li class="none">
                  <a href="../../../hadoop-mapreduce-client/hadoop-mapreduce-client-core/EncryptedShuffle.html">Encrypted Shuffle</a>
            </li>
                  <li class="none">
                  <a href="../../../hadoop-mapreduce-client/hadoop-mapreduce-client-core/PluggableShuffleAndPluggableSort.html">Pluggable Shuffle/Sort</a>
            </li>
                  <li class="none">
                  <a href="../../../hadoop-mapreduce-client/hadoop-mapreduce-client-core/DistributedCacheDeploy.html">Distributed Cache Deploy</a>
            </li>
                  <li class="none">
                  <a href="../../../hadoop-mapreduce-client/hadoop-mapreduce-client-core/SharedCacheSupport.html">Support for YARN Shared Cache</a>
            </li>
          </ul>
                       <h5>MapReduce REST APIs</h5>
                  <ul>
                  <li class="none">
                  <a href="../../../hadoop-mapreduce-client/hadoop-mapreduce-client-core/MapredAppMasterRest.html">MR Application Master</a>
            </li>
                  <li class="none">
                  <a href="../../../hadoop-mapreduce-client/hadoop-mapreduce-client-hs/HistoryServerRest.html">MR History Server</a>
            </li>
          </ul>
                       <h5>YARN</h5>
                  <ul>
                  <li class="none">
                  <a href="../../../hadoop-yarn/hadoop-yarn-site/YARN.html">Architecture</a>
            </li>
                  <li class="none">
                  <a href="../../../hadoop-yarn/hadoop-yarn-site/YarnCommands.html">Commands Reference</a>
            </li>
                  <li class="none">
                  <a href="../../../hadoop-yarn/hadoop-yarn-site/CapacityScheduler.html">Capacity Scheduler</a>
            </li>
                  <li class="none">
                  <a href="../../../hadoop-yarn/hadoop-yarn-site/FairScheduler.html">Fair Scheduler</a>
            </li>
                  <li class="none">
                  <a href="../../../hadoop-yarn/hadoop-yarn-site/ResourceManagerRestart.html">ResourceManager Restart</a>
            </li>
                  <li class="none">
                  <a href="../../../hadoop-yarn/hadoop-yarn-site/ResourceManagerHA.html">ResourceManager HA</a>
            </li>
                  <li class="none">
                  <a href="../../../hadoop-yarn/hadoop-yarn-site/ResourceModel.html">Resource Model</a>
            </li>
                  <li class="none">
                  <a href="../../../hadoop-yarn/hadoop-yarn-site/NodeLabel.html">Node Labels</a>
            </li>
                  <li class="none">
                  <a href="../../../hadoop-yarn/hadoop-yarn-site/NodeAttributes.html">Node Attributes</a>
            </li>
                  <li class="none">
                  <a href="../../../hadoop-yarn/hadoop-yarn-site/WebApplicationProxy.html">Web Application Proxy</a>
            </li>
                  <li class="none">
                  <a href="../../../hadoop-yarn/hadoop-yarn-site/TimelineServer.html">Timeline Server</a>
            </li>
                  <li class="none">
                  <a href="../../../hadoop-yarn/hadoop-yarn-site/TimelineServiceV2.html">Timeline Service V.2</a>
            </li>
                  <li class="none">
                  <a href="../../../hadoop-yarn/hadoop-yarn-site/WritingYarnApplications.html">Writing YARN Applications</a>
            </li>
                  <li class="none">
                  <a href="../../../hadoop-yarn/hadoop-yarn-site/YarnApplicationSecurity.html">YARN Application Security</a>
            </li>
                  <li class="none">
                  <a href="../../../hadoop-yarn/hadoop-yarn-site/NodeManager.html">NodeManager</a>
            </li>
                  <li class="none">
                  <a href="../../../hadoop-yarn/hadoop-yarn-site/DockerContainers.html">Running Applications in Docker Containers</a>
            </li>
                  <li class="none">
                  <a href="../../../hadoop-yarn/hadoop-yarn-site/RuncContainers.html">Running Applications in runC Containers</a>
            </li>
                  <li class="none">
                  <a href="../../../hadoop-yarn/hadoop-yarn-site/NodeManagerCgroups.html">Using CGroups</a>
            </li>
                  <li class="none">
                  <a href="../../../hadoop-yarn/hadoop-yarn-site/SecureContainer.html">Secure Containers</a>
            </li>
                  <li class="none">
                  <a href="../../../hadoop-yarn/hadoop-yarn-site/ReservationSystem.html">Reservation System</a>
            </li>
                  <li class="none">
                  <a href="../../../hadoop-yarn/hadoop-yarn-site/GracefulDecommission.html">Graceful Decommission</a>
            </li>
                  <li class="none">
                  <a href="../../../hadoop-yarn/hadoop-yarn-site/OpportunisticContainers.html">Opportunistic Containers</a>
            </li>
                  <li class="none">
                  <a href="../../../hadoop-yarn/hadoop-yarn-site/Federation.html">YARN Federation</a>
            </li>
                  <li class="none">
                  <a href="../../../hadoop-yarn/hadoop-yarn-site/SharedCache.html">Shared Cache</a>
            </li>
                  <li class="none">
                  <a href="../../../hadoop-yarn/hadoop-yarn-site/UsingGpus.html">Using GPU</a>
            </li>
                  <li class="none">
                  <a href="../../../hadoop-yarn/hadoop-yarn-site/UsingFPGA.html">Using FPGA</a>
            </li>
                  <li class="none">
                  <a href="../../../hadoop-yarn/hadoop-yarn-site/PlacementConstraints.html">Placement Constraints</a>
            </li>
                  <li class="none">
                  <a href="../../../hadoop-yarn/hadoop-yarn-site/YarnUI2.html">YARN UI2</a>
            </li>
          </ul>
                       <h5>YARN REST APIs</h5>
                  <ul>
                  <li class="none">
                  <a href="../../../hadoop-yarn/hadoop-yarn-site/WebServicesIntro.html">Introduction</a>
            </li>
                  <li class="none">
                  <a href="../../../hadoop-yarn/hadoop-yarn-site/ResourceManagerRest.html">Resource Manager</a>
            </li>
                  <li class="none">
                  <a href="../../../hadoop-yarn/hadoop-yarn-site/NodeManagerRest.html">Node Manager</a>
            </li>
                  <li class="none">
                  <a href="../../../hadoop-yarn/hadoop-yarn-site/TimelineServer.html#Timeline_Server_REST_API_v1">Timeline Server</a>
            </li>
                  <li class="none">
                  <a href="../../../hadoop-yarn/hadoop-yarn-site/TimelineServiceV2.html#Timeline_Service_v.2_REST_API">Timeline Service V.2</a>
            </li>
          </ul>
                       <h5>YARN Service</h5>
                  <ul>
                  <li class="none">
                  <a href="../../../hadoop-yarn/hadoop-yarn-site/yarn-service/Overview.html">Overview</a>
            </li>
                  <li class="none">
                  <a href="../../../hadoop-yarn/hadoop-yarn-site/yarn-service/QuickStart.html">QuickStart</a>
            </li>
                  <li class="none">
                  <a href="../../../hadoop-yarn/hadoop-yarn-site/yarn-service/Concepts.html">Concepts</a>
            </li>
                  <li class="none">
                  <a href="../../../hadoop-yarn/hadoop-yarn-site/yarn-service/YarnServiceAPI.html">Yarn Service API</a>
            </li>
                  <li class="none">
                  <a href="../../../hadoop-yarn/hadoop-yarn-site/yarn-service/ServiceDiscovery.html">Service Discovery</a>
            </li>
                  <li class="none">
                  <a href="../../../hadoop-yarn/hadoop-yarn-site/yarn-service/SystemServices.html">System Services</a>
            </li>
          </ul>
                       <h5>Hadoop Compatible File Systems</h5>
                  <ul>
                  <li class="none">
                  <a href="../../../hadoop-aliyun/tools/hadoop-aliyun/index.html">Aliyun OSS</a>
            </li>
                  <li class="none">
                  <a href="../../../hadoop-aws/tools/hadoop-aws/index.html">Amazon S3</a>
            </li>
                  <li class="none">
                  <a href="../../../hadoop-azure/index.html">Azure Blob Storage</a>
            </li>
                  <li class="none">
                  <a href="../../../hadoop-azure-datalake/index.html">Azure Data Lake Storage</a>
            </li>
                  <li class="none">
                  <a href="../../../hadoop-cos/cloud-storage/index.html">Tencent COS</a>
            </li>
                  <li class="none">
                  <a href="../../../hadoop-huaweicloud/cloud-storage/index.html">Huaweicloud OBS</a>
            </li>
          </ul>
                       <h5>Auth</h5>
                  <ul>
                  <li class="none">
                  <a href="../../../hadoop-auth/index.html">Overview</a>
            </li>
                  <li class="none">
                  <a href="../../../hadoop-auth/Examples.html">Examples</a>
            </li>
                  <li class="none">
                  <a href="../../../hadoop-auth/Configuration.html">Configuration</a>
            </li>
                  <li class="none">
                  <a href="../../../hadoop-auth/BuildingIt.html">Building</a>
            </li>
          </ul>
                       <h5>Tools</h5>
                  <ul>
                  <li class="none">
                  <a href="../../../hadoop-streaming/HadoopStreaming.html">Hadoop Streaming</a>
            </li>
                  <li class="none">
                  <a href="../../../hadoop-archives/HadoopArchives.html">Hadoop Archives</a>
            </li>
                  <li class="none">
                  <a href="../../../hadoop-archive-logs/HadoopArchiveLogs.html">Hadoop Archive Logs</a>
            </li>
                  <li class="none">
                  <a href="../../../hadoop-distcp/DistCp.html">DistCp</a>
            </li>
                  <li class="none">
                  <a href="../../../hadoop-federation-balance/HDFSFederationBalance.html">HDFS Federation Balance</a>
            </li>
                  <li class="none">
                  <a href="../../../hadoop-gridmix/GridMix.html">GridMix</a>
            </li>
                  <li class="none">
                  <a href="../../../hadoop-rumen/Rumen.html">Rumen</a>
            </li>
                  <li class="none">
                  <a href="../../../hadoop-resourceestimator/ResourceEstimator.html">Resource Estimator Service</a>
            </li>
                  <li class="none">
                  <a href="../../../hadoop-sls/SchedulerLoadSimulator.html">Scheduler Load Simulator</a>
            </li>
                  <li class="none">
                  <a href="../../../hadoop-project-dist/hadoop-common/Benchmarking.html">Hadoop Benchmarking</a>
            </li>
                  <li class="none">
                  <a href="../../../hadoop-dynamometer/Dynamometer.html">Dynamometer</a>
            </li>
          </ul>
                       <h5>Reference</h5>
                  <ul>
                  <li class="none">
                  <a href="../../../hadoop-project-dist/hadoop-common/release/">Changelog and Release Notes</a>
            </li>
                  <li class="none">
                  <a href="../../../api/index.html">Java API docs</a>
            </li>
                  <li class="none">
                  <a href="../../../hadoop-project-dist/hadoop-common/UnixShellAPI.html">Unix Shell API</a>
            </li>
                  <li class="none">
                  <a href="../../../hadoop-project-dist/hadoop-common/Metrics.html">Metrics</a>
            </li>
          </ul>
                       <h5>Configuration</h5>
                  <ul>
                  <li class="none">
                  <a href="../../../hadoop-project-dist/hadoop-common/core-default.xml">core-default.xml</a>
            </li>
                  <li class="none">
                  <a href="../../../hadoop-project-dist/hadoop-hdfs/hdfs-default.xml">hdfs-default.xml</a>
            </li>
                  <li class="none">
                  <a href="../../../hadoop-project-dist/hadoop-hdfs-rbf/hdfs-rbf-default.xml">hdfs-rbf-default.xml</a>
            </li>
                  <li class="none">
                  <a href="../../../hadoop-mapreduce-client/hadoop-mapreduce-client-core/mapred-default.xml">mapred-default.xml</a>
            </li>
                  <li class="none">
                  <a href="../../../hadoop-yarn/hadoop-yarn-common/yarn-default.xml">yarn-default.xml</a>
            </li>
                  <li class="none">
                  <a href="../../../hadoop-kms/kms-default.html">kms-default.xml</a>
            </li>
                  <li class="none">
                  <a href="../../../hadoop-hdfs-httpfs/httpfs-default.html">httpfs-default.xml</a>
            </li>
                  <li class="none">
                  <a href="../../../hadoop-project-dist/hadoop-common/DeprecatedProperties.html">Deprecated Properties</a>
            </li>
          </ul>
                                 <a href="http://maven.apache.org/" title="Built by Maven" class="poweredBy">
          <img alt="Built by Maven" src="../../images/logos/maven-feather.png"/>
        </a>
                       
                               </div>
    </div>
    <div id="bodyColumn">
      <div id="contentBox">
        <!---
  Licensed under the Apache License, Version 2.0 (the "License");
  you may not use this file except in compliance with the License.
  You may obtain a copy of the License at

   http://www.apache.org/licenses/LICENSE-2.0

  Unless required by applicable law or agreed to in writing, software
  distributed under the License is distributed on an "AS IS" BASIS,
  WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
  See the License for the specific language governing permissions and
  limitations under the License. See accompanying LICENSE file.
-->
<h1>Object Store Auditing: Architecture</h1>
<p>This the architecture document of the S3A <a href="auditing.html">Auditing</a> component.</p>
<p>The S3A auditing subsystem is defined in the package <code>org.apache.hadoop.fs.s3a.audit</code>.</p>
<p>This package is declared <code>LimitedPrivate</code>; some classes inside are explicitly declared <code>@Public</code> (e.g <code>AuditConstants</code>) while others <code>@Private</code>. If declared <code>@Private</code>, external auditing modules MUST NOT use them.</p>

<div class="source">
<div class="source">
<pre>@InterfaceAudience.LimitedPrivate(&quot;auditing extensions&quot;)
@InterfaceStability.Unstable
package org.apache.hadoop.fs.s3a.audit;
</pre></div></div>

<p>The auditing implementation classes are all in the package package <code>org.apache.hadoop.fs.s3a.audit.impl</code>. These MUST NOT be subclassed or invoked directly by external code.</p>
<p>Audit classes/interfaces which are intended to be used across object store clients and manipulated from other parts of hadoop are in <code>hadoop-common</code> JAR in the package <code>org.apache.hadoop.fs.store</code>.</p><section><section>
<h3><a name="Interface_org.apache.hadoop.fs.store.audit.AuditSpan"></a>Interface <code>org.apache.hadoop.fs.store.audit.AuditSpan</code></h3>
<p>An AuditSpan audits a single Hadoop FileSystem API operation such as <code>open(Path)</code>, <code>rename(Path, Path)</code> or <code>listFiles(Path, Boolean)</code>.</p>

<div class="source">
<div class="source">
<pre>public interface AuditSpan extends Closeable {

  String getSpanId();

  String getOperationName();

  long getTimestamp();

  AuditSpan activate();

  void deactivate();

  default void close() {
    deactivate();
  }

  boolean isValidSpan();

  void set(String key, String value);
}
</pre></div></div>

<p>Audit Spans are intended for use <i>within</i> FileSystem clients; that is not visible to applications invoking them.</p>
<ol style="list-style-type: decimal">

<li>One <code>AuditSpan</code> is created per Hadoop FS API call.</li>
<li>Each span has the name of the operation and optionally source and destination paths.</li>
<li>A span may be <code>activate()</code>d or <code>deactivate()</code>d. Between these two operations a span is <i>active</i>.</li>
<li>Activation is on a per-thread basis. A single span can be active in multiple threads simultaneously; other spans may be active in other threads.</li>
<li>A single filesystem can have only one active span per thread, but different filesystem instances MAY have different active spans.</li>
<li>All store operations performed on a thread are considered <i>within</i> the active span.</li>
<li>Spans do not explicitly terminate; they just stop being invoked; eventually Garbage Collection should dispose of them.</li>
<li>Every <code>AuditSpan</code> has an ID, which <i>must</i> be unique. A UUID and a counter is the base implementation.</li>
<li>The <code>AuditSpan</code> class does extend <code>Closeable</code>; calling <code>close()</code> simply deactivates the span <i>for that thread</i>.</li>
<li>All FS API calls which return objects which go on to perform FS operations (<code>create()</code>, <code>open()</code>, incremental list calls which return <code>RemoteIterator</code>  etc) pass the span into the objects which they return.</li>
<li>As a result, any store IO performed by the returned streams and iterators MUST activate the span before that IO and deactivate it afterwards.</li>
<li>There is also the &#x201c;Unbonded Span&#x201d; which is the effective span of an FS when there is no active span.</li>
<li>Calling a store within the unbonded span is generally considered an bug. In the S3A codebase this should never happen outside copy/rename operations, and will be logged at warning level in the Logging Auditor.</li>
</ol></section><section>
<h3><a name="interface_org.apache.hadoop.fs.store.audit.AuditSpanSource"></a>interface <code>org.apache.hadoop.fs.store.audit.AuditSpanSource</code></h3>
<p>This interface is implemented by sources of audit spans.</p>

<div class="source">
<div class="source">
<pre>public interface AuditSpanSource&lt;T extends AuditSpan&gt; {

  T createSpan(String operation,
      @Nullable String path1,
      @Nullable String path2)
      throws IOException;
}
</pre></div></div>

<p>All S3 Auditors implement this interface, as does the <code>AuditManagerS3A</code>. (Implementation note: so do <code>S3AFileSystem</code> and <code>WriteOperationHelper</code>)</p>
<p>When a Hadoop FS API call is made of an <code>S3AFileSystem</code> instance, it calls <code>startOperation</code> on its audit manager; this will relay it to the auditor is bound to.</p>
<p>The auditor then creates and returns a span for the specific operation. The AuditManagerS3A will automatically activate the span returned by the auditor (i.e. assign it the thread local variable tracking the active span in each thread).</p></section><section>
<h3><a name="Memory_Leakage_through_ThreadLocal_misuse"></a>Memory Leakage through <code>ThreadLocal</code> misuse</h3>
<p>The original implementation of the integration with the S3AFileSystem class contained a critical defect, <a class="externalLink" href="https://issues.apache.org/jira/browse/HADOOP-18091">HADOOP-18091</a> <i>S3A auditing leaks memory through ThreadLocal references</i>.</p>
<p>The original code was written with the assumption that when the <code>ActiveAuditManagerS3A</code> service was garbage collected, references in its <code>ThreadLocal</code> field would be freed. In fact, they are retained until all threads with references are terminated. If any long-lived thread had performed an s3 operation which created a span, a reference back to the audit manager instance was created <i>whose lifetime was that of the thread</i></p>
<p>In short-lived processes, and long-lived processes where a limited set of <code>S3AFileSystem</code> instances were reused, this had no adverse effect. Indeed, if the filesystem instances were retained in the cache until the process was shut down, there would be strong references to the owning <code>S3AFileSystem</code> instance anyway.</p>
<p>Where it did have problems was when the following conditions were met 1. Process was long-lived. 2. Long-lived threads in the process invoked filesystem operations on <code>s3a://</code> URLs. 3. Either <code>S3AFileSystem</code> instances were created repeatedly, rather than retrieved from the cache of active instances. 4. Or, after a query for a specific user was completed, <code>FileSystem.closeAllForUGI(UserGroupInformation)</code> was invoked to remove all cached FS instances of that user.</p>
<p>Conditions 1, 2 and 4 are exactly those which long-lived Hive services can encounter.</p>
<p><i>Auditing was disabled by default until a fix was implemented.</i></p>
<p>The memory leak has been fixed using a new class <code>org.apache.hadoop.util.WeakReferenceMap</code> to store a map of thread IDs to active spans. When the S3A filesystem is closed, its audit manager service is stopped and all references to spans removed from the map of thread ID to span.</p>
<p>Weak References are used for the map so that span references do not consume memory even if threads are terminated without resetting the span reference of that thread. There is therefore a theoretical risk that if a garbage collection takes place during execution of a spanned operation, the reference will be lost.</p>
<p>This is not considered an issue as all bounded entry points into the S3A filesystem retain a strong reference to their audit span.</p>
<p>All entry points which return an object which can invoke s3 operations (input and output streams, list iterators, etc.) also retain a strong reference to their span, a reference they activate before performing S3 operations. A factory method is provided to demand-generate a new span if, somehow, these conditions are not met. The &#x201c;unbounded span&#x201d; is used here. Except in deployments where <code>fs.s3a.audit.reject.out.of.span.operations</code> is true, invoking S3 operations within the unbounded span are permitted. That option is set to <code>true</code> within S3A test suites. Therefore it is unlikely that any operations are invoked in unbounded spans except for the special case of copy operations invoked by the transfer manager threads. Those are already ignored in the logging auditor, whose unbounded span ignores requests which <code>AWSRequestAnalyzer.isRequestNotAlwaysInSpan()</code> indicates may happen outside of a span. This is restricted to bucket location probes possibly performed by the SDK on instantiation, and copy part/complete calls.</p>

<div class="source">
<div class="source">
<pre>  public static boolean
      isRequestNotAlwaysInSpan(final Object request) {
    return request instanceof CopyPartRequest
        || request instanceof CompleteMultipartUploadRequest
        || request instanceof GetBucketLocationRequest;
  }
</pre></div></div>
</section><section>
<h3><a name="Class_org.apache.hadoop.fs.audit.CommonAuditContext"></a>Class <code>org.apache.hadoop.fs.audit.CommonAuditContext</code></h3>
<p>This is a class in <code>hadoop-common</code> which provides a context to auditing operations across all instrumented filesystems.</p>
<p>It&#x2019;s Global Context values are a map of string keys and values, which are constant across all threads. This is where global values such as a process UUID and the class executed by <code>ToolRunner</code> are noted.</p>
<p>The <code>CommonAuditContext.currentAuditContext()</code> call returns a thread local <code>CommonAuditContext</code> which is a thread-local map of keys to string values. It also supports a map of <i>evaluated entries</i>. This is a map of type <code>Map&amp;lt;String, Supplier&amp;lt;String&gt;&gt;</code>. supplier methods/lambda expressions set here are dynamically evaluated when auditors retrieve the values. Spans may be used on different thread from that which they were created. Spans MUST always use the values from the <code>currentAuditContext()</code> in the creation thread.</p><section>
<h4><a name="Memory_Usage_of_CommonAuditContext"></a>Memory Usage of <code>CommonAuditContext</code></h4>
<p>The <code>CommonAuditContext</code> map has a <code>ThreadLocal</code> field to store global information which is intended to span multiple operations across multiple filesystems, for example the MapReduce or Spark job ID, which is set in the S3A committers.</p>
<p>Applications and Hadoop code MUST NOT attach context entries which directly or indirectly consumes lots of memory, as the life of that memory use will become that of the thread.</p>
<p>Applications and Hadoop code SHOULD remove context entries when no-longer needed.</p>
<p>If memory leakage is suspected here, set the log <code>org.apache.hadoop.fs.audit.CommonAuditContext</code> to <code>TRACE</code> to log the origin of operations which add log entries.</p>
<p>This will produce a log entry whose stack trace will show the caller chain.</p>

<div class="source">
<div class="source">
<pre>2022-01-26 16:10:28,384 TRACE audit.CommonAuditContext (CommonAuditContext.java:put(149)) - Adding context entry t1
java.lang.Exception: t1
    at org.apache.hadoop.fs.audit.CommonAuditContext.put(CommonAuditContext.java:149)
    at org.apache.hadoop.fs.audit.CommonAuditContext.init(CommonAuditContext.java:192)
    at org.apache.hadoop.fs.audit.CommonAuditContext.createInstance(CommonAuditContext.java:210)
    at org.apache.hadoop.fs.audit.CommonAuditContext.lambda$static$0(CommonAuditContext.java:119)
    at java.lang.ThreadLocal$SuppliedThreadLocal.initialValue(ThreadLocal.java:284)
    at java.lang.ThreadLocal.setInitialValue(ThreadLocal.java:180)
    at java.lang.ThreadLocal.get(ThreadLocal.java:170)
    at org.apache.hadoop.fs.audit.CommonAuditContext.currentAuditContext(CommonAuditContext.java:219)
    at org.apache.hadoop.fs.audit.TestCommonAuditContext.&lt;init&gt;(TestCommonAuditContext.java:54)
</pre></div></div>
</section></section><section>
<h3><a name="class_NoopAuditor"></a>class <code>NoopAuditor</code></h3>
<p>This auditor creates spans which doesn&#x2019;t do anything with the events.</p>

<div class="source">
<div class="source">
<pre>&lt;property&gt;
  &lt;name&gt;fs.s3a.audit.service.classname&lt;/name&gt;
  &lt;value&gt;org.apache.hadoop.fs.s3a.audit.impl.NoopAuditor&lt;/value&gt;
&lt;/property&gt;
</pre></div></div>

<p>This is <i>not</i> the same as disabling auditing, as it still uses the <code>ActiveAuditManagerS3A</code> class which is the source of memory leaks.</p>
<p>Avoid using it except in tests as there is no benefit -simply significant cost.</p></section><section>
<h3><a name="class_LoggingAuditor"></a>class <code>LoggingAuditor</code></h3>
<p>The logging auditor logs operations to the console at DEBUG level (to keep the noise down), and attaches the operation details in the HTTP &#x201c;referer&#x201d; header.</p>
<p>It can be configured to raise an exception whenever an S3 API call is made from within the unbonded span. This option primarily for development, as it is how we can verify that all calls are audited/identify where this is not possible.</p></section><section>
<h3><a name="class_ActiveAuditManager_interface_ActiveAuditManager"></a>class <code>ActiveAuditManager</code> interface <code>ActiveAuditManager</code></h3>
<p>The class <code>ActiveAuditManager</code> provides all the support needed for <code>S3AFileSystem</code> to support spans, including * Loading and starting the auditor declared in a Hadoop configuration. * Maintaining a per-thread record of the active audit span * Switching spans on <code>AuditSpan.activate()</code> and reverting to the unbonded span in <code>deactivate()</code> and <code>close()</code>. * Providing binding classes to be passed into the AWS SDK so as to invoke audit operations prior to requests being issued. This is essential to guarantee that all AWS S3 operations will be audited.</p>
<p>It&#x2019;s a YARN composite service which follows the standard lifecycle. The actual auditor is instantiated initialized and started in its service start phase; closed when the Audit Manager is stopped.</p>

<div class="source">
<div class="source">
<pre>public interface AuditManagerS3A extends Service,
    AuditSpanSource&lt;AuditSpanS3A&gt;,
    AWSAuditEventCallbacks,
    ActiveThreadSpanSource&lt;AuditSpanS3A&gt; {

  /**
   * Get the auditor; valid once initialized.
   * @return the auditor.
   */
  OperationAuditor getAuditor();

  /**
   * Create the request handler(s) for this audit service.
   * The list returned is mutable; new handlers may be added.
   * @return list of handlers for the SDK.
   * @throws IOException failure.
   */
  List&lt;RequestHandler2&gt; createRequestHandlers() throws IOException;

  /**
   * Return a transfer state change callback which
   * fixes the active span context to be that in which
   * the state change listener was created.
   * This can be used to audit the creation of the multipart
   * upload initiation request which the transfer manager
   * makes when a file to be copied is split up.
   * This must be invoked/used within the active span.
   * @return a state change listener.
   */
  TransferStateChangeListener createStateChangeListener();

  /**
   * Check for permission to access a path.
   * The path is fully qualified and the status is the
   * status of the path.
   * This is called from the {@code FileSystem.access()} command
   * and is a soft permission check used by Hive.
   * @param path path to check
   * @param status status of the path.
   * @param mode access mode.
   * @return true if access is allowed.
   * @throws IOException failure
   */
  boolean checkAccess(Path path, S3AFileStatus status, FsAction mode)
      throws IOException;
}
</pre></div></div>
</section></section><section>
<h2><a name="Using_Audit_Spans_within_the_S3A_Connector"></a>Using Audit Spans within the S3A Connector</h2>
<ol style="list-style-type: decimal">

<li>All public FS API calls must be marked as <code>@AuditEntryPoint</code> and initiate  a span.</li>
<li>All interfaces which provided a subset of the store API to another class (e.g. listing) MUST pick up the current span, store it, and activate/deactivate the span when invoked. This ensures use across threads.</li>
<li>Methods/classes which operate across threads must store the audit span which was active on their creation/invocation, and activate it in all threads which interact with the FS. This should be automatic if callback interfaces do this.</li>
<li>All S3 SDK request objects MUST be created in the request factory. Add new methods if need be.</li>
</ol></section><section>
<h2><a name="Implementing_a_custom_OperationAuditor"></a>Implementing a custom <code>OperationAuditor</code></h2>
<p><i>This extension point is <code>@Unstable</code></i></p>

<div class="source">
<div class="source">
<pre>@InterfaceAudience.LimitedPrivate(&quot;S3A auditing extensions&quot;)
@InterfaceStability.Unstable
package org.apache.hadoop.fs.s3a.audit;
</pre></div></div>

<p>A custom <code>OperationAuditor</code> auditor is a class which implements the interface <code>org.apache.hadoop.fs.s3a.audit.OperationAuditor</code>. This SHOULD be done by subclassing <code>org.apache.hadoop.fs.s3a.audit.AbstractOperationAuditor</code>.</p>
<p>It is a YARN service and follows the lifecycle: configured in <code>serviceInit()</code>; start any worker threads/perform startup operations in <code>serviceStart()</code> and shutdown in <code>serviceStop()</code>.</p>
<p>In use, it will be instantiated in <code>S3AFileSystem.initialize()</code> and shutdown when the FS instance is closed.</p>
<p>It will be instantiated before the AWS S3 Client is built -it may provide a request handler to be part of the handler chain of the S3 request pipeline.</p>
<p>It will be closed in the <code>FileSystem.close()</code> operation, after the S3 Client is itself closed.</p><section>
<h3><a name="Design_Decisions.2FReview_questions"></a>Design Decisions/Review questions</h3></section><section>
<h3><a name="Why_use_https:.2F.2Faudit.example.org.2F_as_referrer_host.3F"></a>Why use <a class="externalLink" href="https://audit.example.org/">https://audit.example.org/</a> as referrer host?</h3>
<p>IETF requires *.example.org to be unresolvable through DNS, so with a well configured DNS there&#x2019;s never any host to probe.</p>
<p>It guarantees that there will never be real HTTP requests coming in from that host.</p></section></section><section>
<h2><a name="And_why_hadoop.2F1.2F_in_the_referrer_path.3F"></a>And why <code>hadoop/1/</code> in the referrer path?</h2>
<p>Provenance and versioning.</p><section>
<h3><a name="Why_no_explicit_end_to_an_AuditSpan.3F"></a>Why no explicit end to an AuditSpan?</h3>
<p>While most API calls have a bounded duration, e.g. <code>getFileStatus()</code>, some calls have a very long lifespan (input and output streams). List iterators are never formally terminated, they just &#x201c;fall out of scope&#x201d;, Thus, they&#x2019;d never end.</p>
<p>Having a uniform &#x201c;Audit Spans are never explicitly terminated&#x201d; design means that it is consistent everywhere.</p></section><section>
<h3><a name="Can_you_activate_an_already_active_audit_span.3F"></a>Can you activate an already active audit span?</h3>
<p>It&#x2019;s a no-op.</p>
<p>It does mean that if you deactivate the span the first time, then the thread reverts immediately to the unbonded span.</p></section><section>
<h3><a name="Why_does_AuditSpan.deactivate.28.29_switches_to_the_unbound_span.2C_rather_than_the_span_which_was_active_before"></a>Why does <code>AuditSpan.deactivate()</code> switches to the unbound span, rather than the span which was active before</h3>
<p>Again, it gets complicated fast, especially when audit spans our shared across threads.</p>
<p>Because of the sharing you cannot store the previous span in a field within the AuditSpan itself.</p>
<p>Instead you need to have a thread local stack per FileSystem instance of active audit spans.</p>
<p>And you had better be confident that audit spans are correctly activated and deactivated, with no span deactivated more than once -else the stack will become confused.</p>
<p>Having a simple &#x201c;In Span&#x201d; or &#x201c;Out of Span&#x201d; model avoids this problem. However, it does prevent the S3A FileSystem implementation methods from calling other methods which create new spans. Hence the annotation of all span entry points as <code>@AuditEntryPoint</code> and a need for rigorous review of the invocations. As with the need to make sure that we never call retry() around a method tagged <code>@Retry</code>, making sure that an audit entry point doesn&#x2019;t invoke another audit entry point is going to become another piece of maintenance overhead.</p></section><section>
<h3><a name="History"></a>History</h3>
<ul>

<li>2021-02 Creation. <a class="externalLink" href="https://issues.apache.org/jira/browse/HADOOP-17511">HADOOP-17511</a> <i>Add an Audit plugin point for S3A auditing/context</i>.</li>
</ul></section></section>
      </div>
    </div>
    <div class="clear">
      <hr/>
    </div>
    <div id="footer">
      <div class="xright">
        &#169;            2008-2024
              Apache Software Foundation
            
                          - <a href="http://maven.apache.org/privacy-policy.html">Privacy Policy</a>.
        Apache Maven, Maven, Apache, the Apache feather logo, and the Apache Maven project logos are trademarks of The Apache Software Foundation.
      </div>
      <div class="clear">
        <hr/>
      </div>
    </div>
  </body>
</html>
